<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Presupuesto Personal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8f0ff);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #f0f4ff, #dde7ff);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e6f3ff, #cce7ff);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a5568;
            font-weight: 600;
        }

        .upload-hint {
            color: #718096;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
         background: white;
         padding: 25px;
         border-radius: 15px;
         box-shadow: 0 10px 20px rgba(0,0,0,0.08);
         height: 400px;
        }

        .chart-card canvas {
         max-height: 300px !important;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .budget-section {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .budget-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .budget-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .budget-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: #2d3748;
        }

        .budget-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            /* ESTILOS PARA GASTOS MANUALES */
        .manual-expenses-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .manual-expenses-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .manual-expenses-header h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .manual-expenses-header p {
            color: #4a5568;
            font-size: 1rem;
        }

        .expense-form {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-input {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .form-select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .add-expense-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-expense-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .expenses-list {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .expenses-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-weight: bold;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
        }

        .expense-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
            align-items: center;
            transition: background 0.2s ease;
        }

        .expense-item:hover {
            background: #f8f9fa;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-description {
            font-weight: 600;
            color: #2d3748;
        }

        .expense-amount {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .expense-category {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .category-alimentacion { background: #e6fffa; color: #38b2ac; }
        .category-transporte { background: #fed7d7; color: #e53e3e; }
        .category-entretenimiento { background: #fef5e7; color: #dd6b20; }
        .category-salud { background: #e6fffa; color: #38b2ac; }
        .category-servicios { background: #ebf8ff; color: #3182ce; }
        .category-restaurantes { background: #fef5e7; color: #dd6b20; }
        .category-compras { background: #f0fff4; color: #38a169; }
        .category-otros { background: #f7fafc; color: #4a5568; }

        .expense-date {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .delete-btn {
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #e53e3e;
            color: white;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .show-manual-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .show-manual-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
        /* ESTILOS PARA M√öLTIPLES ARCHIVOS */
        .multiple-files-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .multiple-files-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .multiple-files-header h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8f0ff);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 25px;
        }

        .file-drop-zone:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #f0f4ff, #dde7ff);
            transform: translateY(-2px);
        }

        .file-drop-zone.dragover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e6f3ff, #cce7ff);
            transform: scale(1.02);
        }

        .file-input-multiple {
            display: none;
        }

        .select-files-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .files-queue {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .queue-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-weight: bold;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
        }

        .file-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
            align-items: center;
        }

        .file-progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-pending { background: #fef5e7; color: #dd6b20; }
        .status-processing { background: #ebf8ff; color: #3182ce; }
        .status-completed { background: #e6fffa; color: #38b2ac; }
        .status-error { background: #fed7d7; color: #e53e3e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Analizador de Presupuesto Personal</h1>
            <p>Herramienta gratuita para analizar tus finanzas personales</p>
            <p style="font-size: 1rem; margin-top: 10px; opacity: 0.8;">
                Sube tu estado de cuenta y obt√©n un an√°lisis completo de tus gastos con recomendaciones personalizadas
            </p>
        </div>

        <!-- PASO 1: SUBIR M√öLTIPLES ARCHIVOS -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Arrastra todos tus estados de cuenta aqu√≠</div>
                <div class="upload-hint">Soporta archivos de BBVA, Santander, Banorte, Nu y otros bancos mexicanos</div>
                <div class="upload-hint" style="margin-bottom: 20px; font-weight: 600; color: #667eea;">
                    ‚ú® Nuevo: Sube m√∫ltiples archivos de diferentes bancos de una vez
                </div>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ Seleccionar Estados de Cuenta
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv,.pdf" multiple>
            </div>
        </div>

        <!-- COLA DE ARCHIVOS -->
        <div class="files-queue-section" id="filesQueueSection" style="display: none;">
            <div style="text-align: center; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìã Archivos Listos para Procesar</h3>
                <p style="color: #4a5568;">Revisa tus archivos y procesa cuando est√©s listo</p>
            </div>
            
            <div class="files-queue">
                <div class="queue-header">
                    <div>Archivo</div>
                    <div>Banco</div>
                    <div>Tama√±o</div>
                    <div>Estado</div>
                    <div>Acci√≥n</div>
                </div>
                <div id="filesQueueList">
                    <!-- Archivos se agregan din√°micamente -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button id="processAllFilesBtn" class="process-all-btn" disabled onclick="startProcessingFlow()">
                    ‚ö° Procesar Todos los Archivos
                </button>
                <button onclick="addMoreFiles()" style="background: #718096; color: white; padding: 12px 25px; border: none; border-radius: 25px; margin-left: 15px; cursor: pointer;">
                    ‚ûï Agregar M√°s Archivos
                </button>
            </div>
        </div>

        <!-- PASO 2: GASTOS MANUALES (OCULTO INICIALMENTE) -->
        <div class="manual-expenses-flow" id="manualExpensesFlow" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">üíµ Paso 2: Gastos en Efectivo</h3>
                <p style="color: #4a5568;">Agrega gastos que no aparecen en tus estados de cuenta</p>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>Estados procesados:</strong> <span id="processedBanksInfo">0 archivos</span> | 
                    <strong>Transacciones encontradas:</strong> <span id="processedTransactionsInfo">0</span>
                </div>
            </div>

            <!-- Formulario simplificado para m√∫ltiples gastos -->
            <div class="expense-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="quickExpenseDescription">Descripci√≥n</label>
                        <input type="text" id="quickExpenseDescription" class="form-input" 
                               placeholder="Ej: Comida en puesto" required>
                    </div>
                    <div class="form-group">
                        <label for="quickExpenseAmount">Monto ($)</label>
                        <input type="number" id="quickExpenseAmount" class="form-input" 
                               placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="quickExpenseCategory">Categor√≠a</label>
                        <select id="quickExpenseCategory" class="form-select" required>
                            <option value="">Seleccionar</option>
                            <option value="Alimentaci√≥n">üõí Alimentaci√≥n</option>
                            <option value="Restaurantes">üçï Restaurantes</option>
                            <option value="Transporte">üöó Transporte</option>
                            <option value="Entretenimiento">üé¨ Entretenimiento</option>
                            <option value="Salud">üè• Salud</option>
                            <option value="Compras">üõçÔ∏è Compras</option>
                            <option value="Servicios">‚ö° Servicios</option>
                            <option value="Otros">‚ùì Otros</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button type="button" onclick="addQuickExpense()" class="add-expense-btn">
                            ‚ûï Agregar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista r√°pida de gastos agregados -->
            <div id="quickExpensesList" style="background: white; border-radius: 10px; padding: 20px; margin: 20px 0; max-height: 200px; overflow-y: auto;">
                <div style="text-align: center; color: #718096;">
                    No hay gastos en efectivo agregados
                </div>
            </div>

            <!-- Botones de navegaci√≥n -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="skipManualExpenses()" style="background: #718096; color: white; padding: 15px 30px; border: none; border-radius: 25px; margin-right: 15px; cursor: pointer;">
                    ‚è≠Ô∏è Omitir Gastos en Efectivo
                </button>
                <button onclick="proceedToConsolidated()" class="process-all-btn">
                    üìä Ver An√°lisis Consolidado
                </button>
            </div>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            <div>‚è≥ Procesando tu archivo...</div>
        </div>

        <div id="errorSection" class="error" style="display: none;"></div>
<div id="pendingSection" class="results-section" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <h2 style="color: #667eea; margin-bottom: 20px;">Archivo en proceso</h2>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    No pudimos procesar este estado de cuenta autom√°ticamente, pero estamos trabajando para soportar todos los bancos mexicanos.
                </p>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    D√©janos tu email y el nombre de tu banco, te notificaremos en 24-48h cuando tu reporte est√© listo.
                </p>
                <p style="font-size: 1rem; color: #718096; margin-bottom: 40px;">
                    <strong>¬°No necesitas volver a subir nada!</strong>
                </p>
            </div>

            <div style="max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                <script src="https://js.hsforms.net/forms/embed/50122034.js" defer></script>
                <div class="hs-form-frame" data-region="na1" data-form-id="7ba42206-42b9-4c9f-8d78-209b9166b526" data-portal-id="50122034"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" id="tryAnotherFile" 
                            style="background: none; border: none; color: #667eea; text-decoration: underline; cursor: pointer; font-size: 1rem;">
                        Probar con otro archivo
                    </button>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="totalIngresos">$0</div>
        <div class="stat-label">Ingresos Totales</div>
        
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalExpenses">$0</div>
        <div class="stat-label">Gastos Totales</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="ahorroReal">$0</div>
        <div class="stat-label">Ahorro Real</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="porcentajeAhorro">0%</div>
        <div class="stat-label">% de Ahorro</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalTransactions">0</div>
        <div class="stat-label">Transacciones</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="topCategory">-</div>
        <div class="stat-label">Categor√≠a Principal</div>
    </div>
</div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Gastos por Categor√≠a</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Tendencia Mensual</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="budget-section">
                <div class="budget-title">üéØ Presupuesto Sugerido (Mensual)</div>
                <p style="text-align: center; margin-bottom: 20px; color: #4a5568;">
                    Basado en tu historial de gastos, con un objetivo de optimizaci√≥n del 10%
                </p>
                <div class="budget-categories" id="budgetCategories"></div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px;">
                <p style="color: #718096; font-size: 0.9rem;">
                    üí° <strong>Tip:</strong> Esta herramienta analiza tus patrones de gasto hist√≥ricos. 
                    Para mejores resultados, usa datos de al menos 3 meses.
                </p>
            </div>
            <!-- BOT√ìN PARA MOSTRAR GASTOS MANUALES -->
            <button onclick="showManualExpenses()" class="show-manual-btn">
                üíµ Agregar Gastos en Efectivo
            </button>

            <!-- BOT√ìN PARA M√öLTIPLES ARCHIVOS -->
            <button onclick="showMultipleFiles()" class="show-manual-btn" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                üìÅ Procesar M√∫ltiples Estados de Cuenta
            </button>

            <!-- SECCI√ìN DE M√öLTIPLES ARCHIVOS -->
            <div class="multiple-files-section" id="multipleFilesSection" style="display: none;">
                <div class="multiple-files-header">
                    <h2>üìÅ M√∫ltiples Estados de Cuenta</h2>
                    <p>Sube estados de cuenta de diferentes bancos para un an√°lisis consolidado</p>
                </div>

                <!-- Zona de arrastre -->
                <div class="file-drop-zone" id="fileDropZone">
                    <div style="font-size: 3rem; margin-bottom: 15px; color: #667eea;">üìä</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #4a5568; margin-bottom: 10px;">
                        Arrastra m√∫ltiples archivos aqu√≠
                    </div>
                    <div style="color: #718096; font-size: 0.9rem; margin-bottom: 20px;">
                        O haz clic para seleccionar varios estados de cuenta
                    </div>
                    <button class="select-files-btn" onclick="document.getElementById('fileInputMultiple').click()">
                        üìÅ Seleccionar Archivos
                    </button>
                    <input type="file" id="fileInputMultiple" class="file-input-multiple" 
                           accept=".xlsx,.xls,.csv,.pdf" multiple>
                </div>

                <!-- Cola de archivos -->
                <div class="files-queue" id="filesQueue" style="display: none;">
                    <div class="queue-header">
                        <div>Archivo</div>
                        <div>Tama√±o</div>
                        <div>Estado</div>
                        <div>Progreso</div>
                        <div>Acci√≥n</div>
                    </div>
                    <div id="filesQueueList">
                        <!-- Archivos se agregan din√°micamente -->
                    </div>
                </div>

                <!-- Bot√≥n procesar -->
                <button id="processAllBtn" class="process-all-btn" disabled onclick="processAllFiles()">
                    ‚ö° Sin archivos para procesar
                </button>
            </div>

            <!-- SECCI√ìN DE GASTOS MANUALES -->
            <div class="manual-expenses-section" id="manualExpensesSection" style="display: none;">
                <div class="manual-expenses-header">
                    <h2>üíµ Gastos en Efectivo</h2>
                    <p>Agrega gastos que no aparecen en tu estado de cuenta (efectivo, propinas, etc.)</p>
                </div>

                <!-- Resumen de gastos manuales -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value" id="manualExpensesCount">0</div>
                        <div class="summary-label">Gastos Agregados</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="manualExpensesTotal">$0</div>
                        <div class="summary-label">Total en Efectivo</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="manualExpensesAvg">$0</div>
                        <div class="summary-label">Promedio por Gasto</div>
                    </div>
                </div>

                <!-- Formulario para agregar gastos -->
                <div class="expense-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDescription">Descripci√≥n del Gasto</label>
                            <input type="text" id="expenseDescription" class="form-input" 
                                   placeholder="Ej: Comida en puesto callejero" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Monto ($)</label>
                            <input type="number" id="expenseAmount" class="form-input" 
                                   placeholder="0.00" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Categor√≠a</label>
                            <select id="expenseCategory" class="form-select" required>
                                <option value="">Seleccionar categor√≠a</option>
                                <option value="Alimentaci√≥n">üõí Alimentaci√≥n</option>
                                <option value="Restaurantes">üçï Restaurantes</option>
                                <option value="Transporte">üöó Transporte</option>
                                <option value="Entretenimiento">üé¨ Entretenimiento</option>
                                <option value="Salud">üè• Salud</option>
                                <option value="Compras">üõçÔ∏è Compras</option>
                                <option value="Servicios">‚ö° Servicios</option>
                                <option value="Otros">‚ùì Otros</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">Fecha</label>
                            <input type="date" id="expenseDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="expensePlace">Lugar (opcional)</label>
                            <input type="text" id="expensePlace" class="form-input" 
                                   placeholder="Ej: Mercado local">
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button type="button" id="addExpenseBtn" class="add-expense-btn">
                                ‚ûï Agregar Gasto
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de gastos manuales -->
                <div class="expenses-list">
                    <div class="expenses-header">
                        <div>Descripci√≥n</div>
                        <div>Monto</div>
                        <div>Categor√≠a</div>
                        <div>Fecha</div>
                        <div>Acci√≥n</div>
                    </div>
                    <div id="expensesList">
                        <div class="empty-state">
                            <h3>No hay gastos en efectivo registrados</h3>
                            <p>Agrega tu primer gasto usando el formulario de arriba</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactionData = [];
        let categoryChart = null;
        let trendChart = null;
        let pendingFileData = null;
        // SISTEMA DE APRENDIZAJE
        let learnedPatterns = {};
        let pendingToLearn = {};
        let uncategorizedTransactions = [];

        const categories = {
            'Ingresos': ['spei recibido', 'deposito', 'dep√≥sito', 'transferencia recibida', 'pago de nomina', 'n√≥mina', 'salario', 'sueldo', 'abono', 'intereses', 'rendimiento', 'venta fondos', 'devolucion', 'devoluci√≥n', 'reembolso', 'cashback', 'deposito de inversion', 'liquidacion'],
            'Alimentaci√≥n': ['supermercado', 'mercado', 'abarrotes', 'tienda', 'grocery', 'market', 'soriana', 'walmart', 'chedraui', 'oxxo', 'seven', '7-eleven', 'farmacia guadalajara', 'benavides', 'del rio', 'bodega aurrera', 'comercial mexicana', 'coppel'],
            'Restaurantes': ['restaurante', 'restaurant', 'comida', 'food', 'burger', 'pizza', 'taco', 'caf√©', 'coffee', 'bar', 'cantina', 'mc', 'kfc', 'subway', 'dominos', 'uber eats', 'rappi', 'didi food', 'sin delantal', 'starbucks', 'vips', 'sanborns', 'applebees', 'chilis'],
            'Transporte': ['gasolina', 'gas', 'uber', 'taxi', 'metro', 'autobus', 'bus', 'parking', 'estacionamiento', 'pemex', 'shell', 'bp', 'mobil', 'didi', 'beat', 'caseta', 'autopista', 'peaje'],
            'Entretenimiento': ['cine', 'cinema', 'netflix', 'spotify', 'juego', 'game', 'teatro', 'concierto', 'club', 'gym', 'deporte', 'cinepolis', 'cinemex', 'smart fit', 'sports world', 'disney', 'amazon prime', 'hbo'],
            'Servicios': ['luz', 'agua', 'gas', 'telefono', 'internet', 'cable', 'netflix', 'spotify', 'servicio', 'cfe', 'telmex', 'telcel', 'att', 'movistar', 'unefon', 'izzi', 'sky', 'dish', 'megacable'],
            'Salud': ['farmacia', 'hospital', 'doctor', 'medicina', 'dental', 'laboratorio', 'clinica', 'seguro', 'similares', 'guadalajara', 'benavides', 'del rio', 'issste', 'imss', 'medica sur', 'angeles'],
            'Compras': ['amazon', 'mercadolibre', 'liverpool', 'palacio', 'sears', 'tienda', 'ropa', 'zapatos', 'electronico', 'elektra', 'coppel', 'famsa', 'office depot', 'best buy', 'radioshack'],
            'Efectivo': ['atm', 'cajero', 'retiro', 'efectivo', 'cash', 'disposicion', 'retiro en cajero'],
            'Transferencias': ['spei enviado', 'transferencia', 'pago cuenta tercero', 'pago a tercero', 'envio', 'transferencia enviada'],
            'Otros': []
        };
        // Event listeners
        // VARIABLES GLOBALES PARA EL FLUJO MEJORADO
        let currentStep = 1; // 1: Archivos, 2: Gastos manuales, 3: Consolidado
        let processedFilesData = [];
        let quickManualExpenses = [];
        let allConsolidatedTransactions = [];

        // INICIALIZACI√ìN DEL FLUJO MEJORADO
        document.addEventListener('DOMContentLoaded', function() {
            initImprovedFlow();
        });

        function initImprovedFlow() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            // Event listeners para drag & drop
            uploadArea.addEventListener('dragover', handleDragOverImproved);
            uploadArea.addEventListener('dragleave', handleDragLeaveImproved);
            uploadArea.addEventListener('drop', handleDropImproved);
            uploadArea.addEventListener('click', () => fileInput.click());

            // Event listener para selecci√≥n de archivos
            fileInput.addEventListener('change', handleFileSelectionImproved);

            // Configurar fecha por defecto para gastos manuales
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expenseDate');
            if (dateInput) dateInput.value = today;
        }

        // FUNCIONES DE DRAG & DROP MEJORADAS
        function handleDragOverImproved(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDragLeaveImproved(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDropImproved(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFilesToImprovedQueue(files);
        }

        function handleFileSelectionImproved(e) {
            const files = Array.from(e.target.files);
            addFilesToImprovedQueue(files);
        }

        // AGREGAR ARCHIVOS A LA COLA MEJORADA
        function addFilesToImprovedQueue(files) {
            const validExtensions = ['pdf', 'xlsx', 'xls', 'csv'];
            let validFilesAdded = 0;

            files.forEach(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (validExtensions.includes(extension)) {
                    const fileItem = {
                        id: nextFileId++,
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        status: 'pending',
                        progress: 0,
                        bank: detectBank(file.name),
                        transactions: []
                    };
                    
                    fileQueue.push(fileItem);
                    validFilesAdded++;
                } else {
                    showNotification(`Archivo ${file.name} no v√°lido. Solo PDF, Excel y CSV.`, 'error');
                }
            });

            if (validFilesAdded > 0) {
                updateImprovedFilesDisplay();
                showFilesQueueSection();
            }
        }

        // MOSTRAR SECCI√ìN DE COLA DE ARCHIVOS
        function showFilesQueueSection() {
            document.getElementById('filesQueueSection').style.display = 'block';
            document.getElementById('filesQueueSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ACTUALIZAR VISUALIZACI√ìN MEJORADA
        function updateImprovedFilesDisplay() {
            const queueList = document.getElementById('filesQueueList');
            const processBtn = document.getElementById('processAllFilesBtn');

            if (fileQueue.length === 0) {
                document.getElementById('filesQueueSection').style.display = 'none';
                return;
            }

            queueList.innerHTML = fileQueue.map(file => `
                <div class="file-item">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2rem;">${getFileIcon(file.name)}</span>
                        <div>
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 0.8rem; color: #718096;">${file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">${file.bank.logo}</span>
                        <span style="font-weight: 600;">${file.bank.name}</span>
                    </div>
                    <div style="color: #4a5568;">${file.size}</div>
                    <div class="file-status status-${file.status}" style="padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; text-align: center; font-weight: 600;">
                        ${getStatusText(file.status)}
                    </div>
                    <button onclick="removeFileFromImprovedQueue(${file.id})" style="background: #fed7d7; color: #e53e3e; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-weight: bold;">√ó</button>
                </div>
            `).join('');

            // Actualizar bot√≥n de procesar
            const pendingFiles = fileQueue.filter(f => f.status === 'pending').length;
            processBtn.disabled = pendingFiles === 0;
            processBtn.textContent = pendingFiles > 0 ? 
                `‚ö° Procesar ${pendingFiles} Archivo${pendingFiles > 1 ? 's' : ''}` : 
                '‚ö° Sin archivos pendientes';
        }

        // REMOVER ARCHIVO DE LA COLA
        function removeFileFromImprovedQueue(fileId) {
            fileQueue = fileQueue.filter(file => file.id !== fileId);
            updateImprovedFilesDisplay();
            
            if (fileQueue.length === 0) {
                document.getElementById('filesQueueSection').style.display = 'none';
            }
        }

        // AGREGAR M√ÅS ARCHIVOS
        function addMoreFiles() {
            document.getElementById('fileInput').click();
        }

       async function startProcessingFlow() {
    const pendingFiles = fileQueue.filter(f => f.status === 'pending');
    
    if (pendingFiles.length === 0) {
        showNotification('No hay archivos para procesar', 'warning');
        return;
    }
    
    // IMPORTANTE: NO borrar transactionData aqu√≠ para mantener datos previos
    // Solo limpiar las variables de consolidaci√≥n
    allConsolidatedTransactions.length = 0;
    
    // Procesar todos los archivos
    for (const file of pendingFiles) {
        await processMultipleFile(file);
    }
    
    // Guardar datos procesados
    processedFilesData = fileQueue.filter(f => f.status === 'completed');
    
    // Consolidar transacciones de todos los archivos
    processedFilesData.forEach(file => {
        allConsolidatedTransactions.push(...file.transactions);
    });
    
    // Pasar al paso 2: Gastos manuales
    showManualExpensesStep();
}
            // Pasar al paso 2: Gastos manuales
            showManualExpensesStep();
        }

        // MOSTRAR PASO 2: GASTOS MANUALES
        function showManualExpensesStep() {
            currentStep = 2;
            
            // Ocultar secciones anteriores
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('filesQueueSection').style.display = 'none';
            
            // Mostrar secci√≥n de gastos manuales
            document.getElementById('manualExpensesFlow').style.display = 'block';
            document.getElementById('manualExpensesFlow').scrollIntoView({ behavior: 'smooth' });
            
            // Actualizar informaci√≥n de archivos procesados
            updateProcessedInfo();
            
            showNotification(`Procesados ${processedFilesData.length} archivos correctamente. Ahora agrega gastos en efectivo.`, 'success');
        }

        // ACTUALIZAR INFORMACI√ìN DE ARCHIVOS PROCESADOS
        function updateProcessedInfo() {
            const banksInfo = document.getElementById('processedBanksInfo');
            const transactionsInfo = document.getElementById('processedTransactionsInfo');
            
            const bankNames = processedFilesData.map(f => f.bank.name).join(', ');
            banksInfo.textContent = `${processedFilesData.length} archivo${processedFilesData.length > 1 ? 's' : ''} (${bankNames})`;
            transactionsInfo.textContent = allConsolidatedTransactions.length;
        }
        // Main file processing function
        async function processFile(file) {
            showLoading();
            
            try {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                if (fileExtension === 'csv') {
                    await processCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    await processExcel(file);
                } else if (fileExtension === 'pdf') {
                    await processPDF(file);
                } else {
                    throw new Error('Formato de archivo no soportado. Por favor usa CSV, Excel o PDF.');
                }
                
                if (transactionData.length === 0) {
                    pendingFileData = {
                        file: file,
                        fileName: file.name,
                        timestamp: new Date().toISOString(),
                        fileId: generateFileId()
                    };
                    
                    setTimeout(() => {
                        const hubspotForm = document.querySelector('.hs-form-frame iframe');
                        if (hubspotForm && hubspotForm.contentDocument) {
                            const fileIdField = hubspotForm.contentDocument.querySelector('input[name="file_id"]');
                            if (fileIdField) {
                                fileIdField.value = pendingFileData.fileId;
                            }
                        }
                    }, 2000);
                    
                    showPending();
                    return;
                }
                
               // Limpiar datos de aprendizaje de sesiones anteriores
uncategorizedTransactions = [];

analyzeData();

// Mostrar modal de aprendizaje si hay transacciones sin categorizar
showLearningModal();
                
            } catch (error) {
                pendingFileData = {
                    file: file,
                    fileName: file.name,
                    timestamp: new Date().toISOString(),
                    fileId: generateFileId(),
                    error: error.message
                };
                
                setTimeout(() => {
                    const hubspotForm = document.querySelector('.hs-form-frame iframe');
                    if (hubspotForm && hubspotForm.contentDocument) {
                        const fileIdField = hubspotForm.contentDocument.querySelector('input[name="file_id"]');
                        if (fileIdField) {
                            fileIdField.value = pendingFileData.fileId;
                        }
                    }
                }, 2000);
                
                showPending();
            }
        }

        function generateFileId() {
            return 'file_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }
        // File processing functions
        async function processCSV(file) {
            const text = await file.text();
            const lines = text.split('\n');
            
            if (lines.length < 2) {
                throw new Error('El archivo CSV debe tener al menos una l√≠nea de encabezado y una de datos.');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            transactionData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const transaction = parseTransaction(headers, values);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
                throw new Error('El archivo Excel debe tener al menos una l√≠nea de encabezado y una de datos.');
            }
            
            const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
            transactionData = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                if (jsonData[i].length > 0) {
                    const transaction = parseTransaction(headers, jsonData[i]);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('Texto extra√≠do del PDF:', fullText.substring(0, 500) + '...');
                
                if (fullText.includes('BBVA') || fullText.includes('bbva')) {
                    await processBBVAPDF(fullText);
                } else if (fullText.includes('Nu M√©xico') || fullText.includes('Cuenta Nu')) {
                    await processNuPDF(fullText);
                } else if (fullText.includes('Santander') || fullText.includes('SANTANDER')) {
                    await processSantanderPDF(fullText);
                } else if (fullText.includes('Banorte') || fullText.includes('BANORTE')) {
                    await processBanortePDF(fullText);
                } else {
                    await processGenericPDF(fullText);
                }
                
            } catch (error) {
                console.error('Error procesando PDF:', error);
                throw new Error('Error al procesar el PDF. Aseg√∫rate de que sea un estado de cuenta v√°lido.');
            }
        }
        // Bank-specific PDF processors
     // PROCESADOR BBVA FINAL - MANEJO DE L√çNEAS CONCATENADAS
async function processBBVAPDF(text) {
    console.log('=== PROCESADOR BBVA FINAL v4 ===');
    transactionData.length = 0;
    
    // Buscar todas las transacciones usando regex m√°s espec√≠ficos
    const allTransactions = [];
    
    // Patr√≥n para encontrar transacciones individuales
    // Busca: FECHA FECHA DESCRIPCION MONTO (m√∫ltiples formatos)
    const transactionPattern = /(\d{1,2}\/[A-Z]{3})\s+(\d{1,2}\/[A-Z]{3})\s+([^0-9]+?)\s+([\d,]+\.\d{2})/g;
    
    let match;
    while ((match = transactionPattern.exec(text)) !== null) {
        const [fullMatch, date1, date2, description, amount] = match;
        
        const numAmount = parseFloat(amount.replace(/,/g, ''));
        if (numAmount > 0) {
            allTransactions.push({
                date1: date1,
                date2: date2,
                description: description.trim(),
                amount: numAmount,
                fullMatch: fullMatch,
                position: match.index
            });
        }
    }
    
    console.log(`Encontradas ${allTransactions.length} transacciones potenciales`);
    
    // Procesar cada transacci√≥n
    allTransactions.forEach((transaction, index) => {
        const { description, amount, date1 } = transaction;
        
       // Determinar tipo basado en palabras clave espec√≠ficas
let isIncome = false;

const desc = description.toUpperCase();

// GASTOS PRIMERO - m√°s espec√≠ficos
if (desc.includes('SPEI ENVIADO') || 
    desc.includes('RETIRO') ||
    desc.includes('PAGO CUENTA') ||
    desc.includes('CAJERO AUTOMATICO') ||
    desc.includes('DISPOSICION') ||
    desc.includes('CARGO') ||
    desc.includes('COMISION')) {
    isIncome = false; // ES GASTO
    console.log(`GASTO detectado: ${description.substring(0, 30)}`);
}
// INGRESOS DESPU√âS - solo si NO es gasto
else if (desc.includes('SPEI RECIBIDO') || 
         desc.includes('DEPOSITO') && !desc.includes('TERCERO') ||
         desc.includes('ABONO') ||
         desc.includes('TRANSFERENCIA RECIBIDA') ||
         desc.includes('VENTA FONDOS') ||
         desc.includes('DEVOLUCION')) {
    isIncome = true; // ES INGRESO
    console.log(`INGRESO detectado: ${description.substring(0, 30)}`);
}
// POR DEFECTO: SI NO EST√Å CLARO, ES GASTO
else {
    isIncome = false; // DEFAULT: GASTO
    console.log(`GASTO por defecto: ${description.substring(0, 30)}`);
}

const category = isIncome ? 'Ingresos' : categorizeExpenseByDescription(description);        
        const processedTransaction = {
            description: description,
            amount: amount,
            date: parseBBVADate(date1),
            category: category,
            type: isIncome ? 'INGRESO' : 'GASTO'
        };
        
        transactionData.push(processedTransaction);
        
        if (index < 10) {
            console.log(`Transacci√≥n ${index + 1}: ${category} - ${description.substring(0, 40)} - $${amount}`);
        }
    });
    
    console.log(`BBVA Final: Procesadas ${transactionData.length} transacciones`);
    
    // Estad√≠sticas finales
    const finalStats = {
        ingresos: { count: 0, total: 0 },
        gastos: { count: 0, total: 0 }
    };
    
    transactionData.forEach(t => {
        if (t.category === 'Ingresos') {
            finalStats.ingresos.count++;
            finalStats.ingresos.total += t.amount;
        } else {
            finalStats.gastos.count++;
            finalStats.gastos.total += t.amount;
        }
    });
    
    console.log(`FINAL - Ingresos: ${finalStats.ingresos.count} transacciones, $${finalStats.ingresos.total.toLocaleString()}`);
    console.log(`FINAL - Gastos: ${finalStats.gastos.count} transacciones, $${finalStats.gastos.total.toLocaleString()}`);
    
    // Verificaci√≥n contra totales esperados
    const expectedTotal = finalStats.ingresos.total + finalStats.gastos.total;
    console.log(`Total procesado: $${expectedTotal.toLocaleString()} (esperado ~$68,000)`);
}

// Funci√≥n mejorada para categorizar gastos
function categorizeExpenseByDescription(description) {
    const desc = description.toUpperCase();
    
    // Transporte
    if (desc.includes('UBER') || desc.includes('TAXI') || desc.includes('GASOLINA') || desc.includes('GAS')) {
        return 'Transporte';
    }
    
    // Alimentaci√≥n
    if (desc.includes('ABARROTES') || desc.includes('SUPERMERCADO') || desc.includes('MERCADO') || desc.includes('TIENDA')) {
        return 'Alimentaci√≥n';
    }
    
    // Restaurantes
    if (desc.includes('RESTAURANT') || desc.includes('COMIDA') || desc.includes('FRUTA')) {
        return 'Restaurantes';
    }
    
    // Efectivo
    if (desc.includes('RETIRO') || desc.includes('CAJERO') || desc.includes('EFECTIVO') || desc.includes('ATM')) {
        return 'Efectivo';
    }
    
    // Transferencias/Pagos
    if (desc.includes('SPEI ENVIADO') || desc.includes('PAGO CUENTA') || desc.includes('TRANSFERENCIA')) {
        return 'Transferencias';
    }
    
    // Servicios
    if (desc.includes('PENSION') || desc.includes('RENTA') || desc.includes('DONATIVO')) {
        return 'Servicios';
    }
    
    // Salud
    if (desc.includes('FARMACIA') || desc.includes('FAR GUAD')) {
        return 'Salud';
    }
    
    // Compras
    if (desc.includes('ROPA') || desc.includes('TIENDA') || desc.includes('COMPRA')) {
        return 'Compras';
    }
    
    // Entretenimiento
    if (desc.includes('CINE') || desc.includes('JUEGO') || desc.includes('DIVERSIO')) {
        return 'Entretenimiento';
    }
    
    return 'Otros';
}
        async function processNuPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const transactionPattern = /(\d{1,2} [A-Z]{3} \d{4})\s+(.+?)\s+([-+]?\$?[\d,]+\.?\d*)/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                const match = line.match(transactionPattern);
                if (match) {
                    const [_, fecha, descripcion, montoStr] = match;
                    
                    let amount = parseFloat(montoStr.replace(/[$,\s-]/g, ''));
                    
                    const isNegative = montoStr.includes('-');
                    if (isNegative && amount > 0) {
    const transaction = {
        description: descripcion.trim(),
        amount: amount,
        date: parseNuDate(fecha),
        category: categorizeTransaction(descripcion)
    };
    transactionData.push(transaction);
}
                }
            }
            
            console.log(`Nu: Procesadas ${transactionData.length} transacciones`);
        }

        async function processSantanderPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePattern = /(\d{2}\/\d{2}\/\d{4})/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (datePattern.test(line) && line.includes('$')) {
                    const parts = line.split(/\s+/);
                    const fecha = parts.find(part => datePattern.test(part));
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (fecha && montoMatch) {
                        const descripcion = line.replace(fecha, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(fecha),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Santander: Procesadas ${transactionData.length} transacciones`);
        }

        async function processBanortePDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePattern = /(\d{2}-\d{2}-\d{4}|\d{2}\/\d{2}\/\d{4})/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (datePattern.test(line) && line.includes('$')) {
                    const parts = line.split(/\s+/);
                    const fecha = parts.find(part => datePattern.test(part));
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (fecha && montoMatch) {
                        const descripcion = line.replace(fecha, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(fecha.replace(/-/g, '/')),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Banorte: Procesadas ${transactionData.length} transacciones`);
        }

        async function processGenericPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePatterns = [
                /(\d{1,2}\/\d{1,2}\/\d{4})/,
                /(\d{1,2}-\d{1,2}-\d{4})/,
                /(\d{1,2} [A-Z]{3} \d{4})/,
                /(\d{1,2}\/[A-Z]{3}\/\d{4})/
            ];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                let dateFound = null;
                for (const pattern of datePatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        dateFound = match[1];
                        break;
                    }
                }
                
                if (dateFound && line.includes('$')) {
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (montoMatch) {
                        const descripcion = line.replace(dateFound, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0 && descripcion.length > 5) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(dateFound),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Gen√©rico: Procesadas ${transactionData.length} transacciones`);
        }
        // Utility functions
        function parseNuDate(dateStr) {
            const parts = dateStr.split(' ');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const monthStr = parts[1];
                const year = parseInt(parts[2]);
                
                const monthMap = {
                    'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                    'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
                };
                
                const month = monthMap[monthStr];
                if (month !== undefined) {
                    return new Date(year, month, day);
                }
            }
            
            return new Date();
        }

       function parseTransaction(headers, values) {
    const transaction = {};
    
    const descriptionFields = ['descripcion', 'descripci√≥n', 'concepto', 'description', 'merchant', 'comercio', 'movimiento'];
    const amountFields = ['monto', 'importe', 'amount', 'cantidad', 'cargo', 'abono', 'importe neto'];
    const dateFields = ['fecha', 'date', 'dia'];
    
    let description = '';
    let amount = 0;
    let date = new Date();
    
    headers.forEach((header, index) => {
        const value = values[index];
        const headerLower = String(header || '').toLowerCase().trim();
        
        if (descriptionFields.some(field => headerLower.includes(field))) {
            description = String(value || '');
        }
        
        if (amountFields.some(field => headerLower.includes(field))) {
            const cleanValue = String(value || '0').replace(/[,$\s]/g, '');
            const numValue = parseFloat(cleanValue);
            if (!isNaN(numValue) && Math.abs(numValue) > Math.abs(amount)) {
                amount = numValue;
            }
        }
        
        if (dateFields.some(field => headerLower.includes(field))) {
            const dateValue = parseBBVADate(value);
            if (dateValue && !isNaN(dateValue.getTime())) {
                date = dateValue;
            }
        }
    });
    
    // CAMBIO PRINCIPAL: Procesar TODAS las transacciones
    if (description && Math.abs(amount) > 0) {
        return {
            description: description,
            amount: Math.abs(amount),
            date: date,
            category: categorizeTransaction(description)
        };
    }
    
    return null;
}
        function parseBBVADate(dateStr) {
            if (!dateStr) return new Date();
            
            const str = String(dateStr).trim();
            
            if (str.includes('/') && str.length <= 10) {
                const parts = str.split('/');
                if (parts.length === 2) {
                    const day = parseInt(parts[0]);
                    const monthStr = parts[1].toUpperCase();
                    
                    const monthMap = {
                        'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                        'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
                    };
                    
                    const month = monthMap[monthStr];
                    if (month !== undefined && day >= 1 && day <= 31) {
                        const currentYear = new Date().getFullYear();
                        return new Date(currentYear, month, day);
                    }
                }
            }
            
            const standardDate = new Date(dateStr);
            if (!isNaN(standardDate.getTime())) {
                return standardDate;
            }
            
            return new Date();
        }

        function categorizeTransaction(description) {
            const desc = description.toLowerCase();
            
            for (const [category, keywords] of Object.entries(categories)) {
                if (category === 'Otros') continue;
                
                for (const keyword of keywords) {
                    if (desc.includes(keyword)) {
                        return category;
                    }
                }
            }
            
            return 'Otros';
        }

        // NUEVA FUNCI√ìN: Categorizaci√≥n inteligente con aprendizaje
function categorizeTransactionSmart(description) {
    const desc = description.toLowerCase();
    
    // PASO 1: Verificar patrones ya aprendidos
    for (const [pattern, category] of Object.entries(learnedPatterns)) {
        if (desc.includes(pattern.toLowerCase())) {
            return category;
        }
    }
    
    // PASO 2: Categorizaci√≥n autom√°tica tradicional
    for (const [category, keywords] of Object.entries(categories)) {
        if (category === 'Otros') continue;
        
        for (const keyword of keywords) {
            if (desc.includes(keyword)) {
                return category;
            }
        }
    }
    
    // PASO 3: Si no encuentra categor√≠a, guardar para aprendizaje
    const cleanDesc = extractMainWords(description);
    
    // Verificar si ya apareci√≥ antes
    if (pendingToLearn[cleanDesc]) {
        pendingToLearn[cleanDesc].count++;
        pendingToLearn[cleanDesc].lastSeen = new Date();
    } else {
        pendingToLearn[cleanDesc] = {
            count: 1,
            originalDescription: description,
            lastSeen: new Date()
        };
    }
    
    // Agregar a lista de no categorizadas
    uncategorizedTransactions.push({
        description: description,
        cleanDescription: cleanDesc
    });
    
    return 'Otros';
}

// FUNCI√ìN AUXILIAR: Extraer palabras principales para crear patrones
function extractMainWords(description) {
    // Limpiar y extraer palabras importantes
    const cleaned = description.toLowerCase()
        .replace(/\d+/g, '') // Quitar n√∫meros
        .replace(/[^\w\s]/g, ' ') // Quitar caracteres especiales
        .trim();
    
    const words = cleaned.split(/\s+/)
        .filter(word => word.length > 3) // Solo palabras de m√°s de 3 caracteres
        .slice(0, 2); // Tomar las primeras 2 palabras importantes
    
    return words.join(' ');
}
        // Analysis and visualization functions
        function analyzeData() {
    // Separar ingresos y gastos
    const ingresos = transactionData.filter(t => t.category === 'Ingresos');
    const gastos = transactionData.filter(t => t.category !== 'Ingresos');
    
    const totalIngresos = ingresos.reduce((sum, t) => sum + t.amount, 0);
    const totalGastos = gastos.reduce((sum, t) => sum + t.amount, 0);
    const totalTransactions = transactionData.length;
    
    // Calcular m√©tricas financieras
    const ahorroReal = totalIngresos - totalGastos;
    const porcentajeAhorro = totalIngresos > 0 ? ((ahorroReal / totalIngresos) * 100) : 0;
    const avgTransaction = totalGastos / gastos.length;
    
    // Categorizar solo gastos para el an√°lisis
    const categoryTotals = {};
    gastos.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
    });
    
    const topCategory = Object.keys(categoryTotals).length > 0 ? 
        Object.keys(categoryTotals).reduce((a, b) => 
            categoryTotals[a] > categoryTotals[b] ? a : b
        ) : 'N/A';
    
    // Actualizar m√©tricas en pantalla
    document.getElementById('totalExpenses').textContent = `$${totalGastos.toLocaleString()}`;
    document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
    //document.getElementById('avgTransaction').textContent = `$${avgTransaction.toLocaleString()}`;
    document.getElementById('topCategory').textContent = topCategory;
    
    // Agregar nuevas m√©tricas si existen los elementos
    if (document.getElementById('totalIngresos')) {
        document.getElementById('totalIngresos').textContent = `$${totalIngresos.toLocaleString()}`;
    }
    if (document.getElementById('ahorroReal')) {
        document.getElementById('ahorroReal').textContent = `$${ahorroReal.toLocaleString()}`;
    }
    if (document.getElementById('porcentajeAhorro')) {
        document.getElementById('porcentajeAhorro').textContent = `${porcentajeAhorro.toFixed(1)}%`;
    }
    
    createCategoryChart(categoryTotals);
    createTrendChart();
    createBudgetSuggestions(categoryTotals, totalGastos, totalIngresos);
}
        function createCategoryChart(categoryTotals) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const monthlyData = {};
            transactionData.forEach(t => {
                const monthKey = t.date.toISOString().substring(0, 7);
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + t.amount;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const date = new Date(month + '-01');
                        return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                    }),
                    datasets: [{
                        label: 'Gastos Mensuales',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBudgetSuggestions(categoryTotals, totalExpenses, totalIngresos = 0) {
    const budgetContainer = document.getElementById('budgetCategories');
    budgetContainer.innerHTML = '';
    
    // Mostrar an√°lisis de ingresos vs gastos si hay ingresos
    if (totalIngresos > 0) {
        const ratioGastos = ((totalExpenses / totalIngresos) * 100).toFixed(1);
        const ahorroSugerido = totalIngresos * 0.2; // 20% de ahorro recomendado
        const gastoMaximo = totalIngresos * 0.8; // 80% m√°ximo en gastos
        
        const summaryItem = document.createElement('div');
        summaryItem.className = 'budget-item';
        summaryItem.style.gridColumn = '1 / -1';
        summaryItem.style.background = ratioGastos > 80 ? 'rgba(255, 99, 132, 0.1)' : 'rgba(75, 192, 192, 0.1)';
        summaryItem.innerHTML = `
            <div>
                <div class="category-name">üìä An√°lisis Financiero</div>
                <div style="font-size: 0.9rem; color: #718096;">
                    Gastas ${ratioGastos}% de tus ingresos ‚Ä¢ 
                    ${ratioGastos > 80 ? '‚ö†Ô∏è Riesgo alto' : ratioGastos > 60 ? '‚ö° Moderado' : '‚úÖ Saludable'}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: #718096;">Ahorro sugerido</div>
                <div class="budget-amount">$${ahorroSugerido.toLocaleString()}</div>
            </div>
        `;
        budgetContainer.appendChild(summaryItem);
    }
    
    const improvementFactor = 0.9;
    
    Object.entries(categoryTotals).forEach(([category, amount]) => {
        const suggestedAmount = Math.round(amount * improvementFactor);
        const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
        
        const budgetItem = document.createElement('div');
        budgetItem.className = 'budget-item';
        budgetItem.innerHTML = `
            <div>
                <div class="category-name">${category}</div>
                <div style="font-size: 0.9rem; color: #718096;">${percentage}% del total</div>
            </div>
            <div class="budget-amount">$${suggestedAmount.toLocaleString()}</div>
        `;
        
        budgetContainer.appendChild(budgetItem);
    });
}
        // FUNCIONES DEL SISTEMA DE APRENDIZAJE

function showLearningModal() {
    if (uncategorizedTransactions.length === 0) {
        // No hay transacciones para aprender, continuar normalmente
        showResults();
        return;
    }
    
    const modal = document.getElementById('learningModal');
    const container = document.getElementById('learningTransactions');
    container.innerHTML = '';
    
    // Eliminar duplicados
    const uniqueTransactions = [...new Set(uncategorizedTransactions.map(t => t.cleanDescription))]
        .map(cleanDesc => uncategorizedTransactions.find(t => t.cleanDescription === cleanDesc));
    
    uniqueTransactions.forEach((transaction, index) => {
        const transactionDiv = document.createElement('div');
        transactionDiv.style.cssText = `
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        `;
        
        transactionDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 10px; color: #2d3748;">
                "${transaction.description}"
            </div>
            <div style="margin-bottom: 15px; color: #4a5568;">
                ¬øA qu√© categor√≠a pertenece este gasto?
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="learn-btn" data-category="Alimentaci√≥n" data-pattern="${transaction.cleanDescription}">üõí Alimentaci√≥n</button>
                <button class="learn-btn" data-category="Restaurantes" data-pattern="${transaction.cleanDescription}">üçï Restaurantes</button>
                <button class="learn-btn" data-category="Transporte" data-pattern="${transaction.cleanDescription}">üöó Transporte</button>
                <button class="learn-btn" data-category="Servicios" data-pattern="${transaction.cleanDescription}">‚ö° Servicios</button>
                <button class="learn-btn" data-category="Salud" data-pattern="${transaction.cleanDescription}">üè• Salud</button>
                <button class="learn-btn" data-category="Entretenimiento" data-pattern="${transaction.cleanDescription}">üé¨ Entretenimiento</button>
                <button class="learn-btn" data-category="Compras" data-pattern="${transaction.cleanDescription}">üõçÔ∏è Compras</button>
                <button class="learn-btn" data-category="Efectivo" data-pattern="${transaction.cleanDescription}">üíµ Efectivo</button>
                <button class="learn-btn" data-category="Otros" data-pattern="${transaction.cleanDescription}">‚ùì No lo s√©</button>
            </div>
        `;
        
        container.appendChild(transactionDiv);
    });
    
    modal.style.display = 'block';
    
    // Event listeners para los botones de categor√≠a
    document.querySelectorAll('.learn-btn').forEach(btn => {
        btn.addEventListener('click', handleCategorySelection);
    });
    
    // Event listener para finalizar
    document.getElementById('finishLearning').addEventListener('click', finishLearning);
}

function handleCategorySelection(e) {
    const pattern = e.target.dataset.pattern;
    const category = e.target.dataset.category;
    
    if (category !== 'Otros') {
        // Aprender el patr√≥n
        learnedPatterns[pattern] = category;
        
        // Recategorizar transacciones con este patr√≥n
        transactionData.forEach(transaction => {
            if (transaction.description.toLowerCase().includes(pattern.toLowerCase())) {
                transaction.category = category;
            }
        });
    }
    
    // Marcar como seleccionado
    e.target.style.background = '#667eea';
    e.target.style.color = 'white';
    
    // Deshabilitar otros botones de este grupo
    const parentDiv = e.target.parentElement;
    parentDiv.querySelectorAll('.learn-btn').forEach(btn => {
        if (btn !== e.target) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    });
}

function finishLearning() {
    document.getElementById('learningModal').style.display = 'none';
    
    // Recalcular an√°lisis con las nuevas categor√≠as
    analyzeData();
    showResults();
}

// CSS para los botones de aprendizaje
const style = document.createElement('style');
style.textContent = `
    .learn-btn {
        background: white;
        border: 2px solid #e2e8f0;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    .learn-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    .learn-btn:disabled {
        cursor: not-allowed;
    }
`;
document.head.appendChild(style);
        // SISTEMA DE GASTOS MANUALES
        let manualExpenses = [];
        let nextExpenseId = 1000; // Empezar en 1000 para evitar conflictos

        // Inicializar gastos manuales cuando se carga la p√°gina
        function initManualExpenses() {
            // Configurar fecha por defecto (hoy)
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expenseDate');
            if (dateInput) {
                dateInput.value = today;
            }

            // Event listeners
            const addBtn = document.getElementById('addExpenseBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addManualExpense);
            }
            
            // Enter para agregar gasto
            const amountInput = document.getElementById('expenseAmount');
            if (amountInput) {
                amountInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addManualExpense();
                    }
                });
            }
        }

        // Funci√≥n para mostrar la secci√≥n de gastos manuales
        function showManualExpenses() {
            const section = document.getElementById('manualExpensesSection');
            if (section) {
                section.style.display = 'block';
                initManualExpenses();
                
                // Scroll suave a la secci√≥n
                section.scrollIntoView({ behavior: 'smooth' });
                
                // Focus en el primer campo
                setTimeout(() => {
                    const descInput = document.getElementById('expenseDescription');
                    if (descInput) descInput.focus();
                }, 500);
            }
        }

        // Funci√≥n para agregar gasto manual
        function addManualExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const date = document.getElementById('expenseDate').value;
            const place = document.getElementById('expensePlace').value.trim();

            // Validaciones
            if (!description) {
                alert('Por favor ingresa una descripci√≥n');
                document.getElementById('expenseDescription').focus();
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                document.getElementById('expenseAmount').focus();
                return;
            }
            
            if (!category) {
                alert('Por favor selecciona una categor√≠a');
                document.getElementById('expenseCategory').focus();
                return;
            }
            
            if (!date) {
                alert('Por favor selecciona una fecha');
                document.getElementById('expenseDate').focus();
                return;
            }

            // Crear nuevo gasto
            const newExpense = {
                id: nextExpenseId++,
                description: description,
                amount: amount,
                category: category,
                date: new Date(date),
                place: place,
                isManual: true
            };

            // Agregar a la lista
            manualExpenses.push(newExpense);

            // Agregar a transactionData global para an√°lisis
            transactionData.push(newExpense);
            
            // Recalcular an√°lisis
            analyzeData();

            // Actualizar UI
            updateManualExpensesDisplay();
            clearExpenseForm();

            console.log('Gasto manual agregado:', newExpense);
            
            // Mostrar confirmaci√≥n
            showSuccessMessage(`Gasto de $${amount.toLocaleString()} agregado correctamente`);
        }

        // Funci√≥n para eliminar gasto manual
        function deleteManualExpense(expenseId) {
            if (confirm('¬øEst√°s seguro de eliminar este gasto?')) {
                // Eliminar de lista manual
                manualExpenses = manualExpenses.filter(exp => exp.id !== expenseId);
                
                // Eliminar de transactionData global
                transactionData = transactionData.filter(t => t.id !== expenseId);
                
                // Recalcular an√°lisis
                analyzeData();
                
                updateManualExpensesDisplay();
                
                showSuccessMessage('Gasto eliminado correctamente');
            }
        }

        // Funci√≥n para actualizar la visualizaci√≥n
        function updateManualExpensesDisplay() {
            const expensesList = document.getElementById('expensesList');
            const count = document.getElementById('manualExpensesCount');
            const total = document.getElementById('manualExpensesTotal');
            const avg = document.getElementById('manualExpensesAvg');

            if (!expensesList || !count || !total || !avg) return;

            // Actualizar resumen
            const totalAmount = manualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const avgAmount = manualExpenses.length > 0 ? totalAmount / manualExpenses.length : 0;

            count.textContent = manualExpenses.length;
            total.textContent = `$${totalAmount.toLocaleString()}`;
            avg.textContent = `$${avgAmount.toLocaleString()}`;

            // Actualizar lista
            if (manualExpenses.length === 0) {
                expensesList.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay gastos en efectivo registrados</h3>
                        <p>Agrega tu primer gasto usando el formulario de arriba</p>
                    </div>
                `;
            } else {
                expensesList.innerHTML = manualExpenses
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(expense => {
                        const categoryClass = `category-${expense.category.toLowerCase().replace(/[√°√©√≠√≥√∫]/g, function(match) {
                            const accents = { '√°': 'a', '√©': 'e', '√≠': 'i', '√≥': 'o', '√∫': 'u' };
                            return accents[match];
                        })}`;
                        const formattedDate = expense.date.toLocaleDateString('es-ES');
                        const displayDescription = expense.place ? 
                            `${expense.description} (${expense.place})` : 
                            expense.description;

                        return `
                            <div class="expense-item">
                                <div class="expense-description">${displayDescription}</div>
                                <div class="expense-amount">$${expense.amount.toLocaleString()}</div>
                                <div class="expense-category ${categoryClass}">${expense.category}</div>
                                <div class="expense-date">${formattedDate}</div>
                                <button class="delete-btn" onclick="deleteManualExpense(${expense.id})" title="Eliminar gasto">√ó</button>
                            </div>
                        `;
                    }).join('');
            }
        }

        // Funci√≥n para limpiar formulario
        function clearExpenseForm() {
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expensePlace').value = '';
            
            // Mantener la fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            // Focus en descripci√≥n para siguiente gasto
            document.getElementById('expenseDescription').focus();
        }

        // Funci√≥n para mostrar mensaje de √©xito
        function showSuccessMessage(message) {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #48bb78;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
                z-index: 1000;
                font-weight: 600;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Mostrar con animaci√≥n
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        // SISTEMA DE M√öLTIPLES ARCHIVOS
        let fileQueue = [];
        let nextFileId = 1;

        // Funci√≥n para mostrar m√∫ltiples archivos
        function showMultipleFiles() {
            const section = document.getElementById('multipleFilesSection');
            if (section) {
                section.style.display = 'block';
                initMultipleFiles();
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Inicializar sistema
        function initMultipleFiles() {
            const fileInput = document.getElementById('fileInputMultiple');
            const dropZone = document.getElementById('fileDropZone');

            // Drag & Drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                addFilesToQueue(files);
            });

            // Selecci√≥n de archivos
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                addFilesToQueue(files);
            });
        }

        // Agregar archivos a la cola
        function addFilesToQueue(files) {
            const validExtensions = ['pdf', 'xlsx', 'xls', 'csv'];
            
            files.forEach(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (validExtensions.includes(extension)) {
                    const fileItem = {
                        id: nextFileId++,
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        status: 'pending',
                        progress: 0,
                        bank: detectBank(file.name)
                    };
                    
                    fileQueue.push(fileItem);
                } else {
                    alert(`Archivo ${file.name} no v√°lido. Solo PDF, Excel y CSV.`);
                }
            });

            updateFilesDisplay();
        }

        // Detectar banco
        function detectBank(fileName) {
            const name = fileName.toLowerCase();
            
            if (name.includes('bbva')) return { name: 'BBVA', logo: 'üè¶' };
            if (name.includes('santander')) return { name: 'Santander', logo: 'üî¥' };
            if (name.includes('banorte')) return { name: 'Banorte', logo: 'üü†' };
            if (name.includes('nu')) return { name: 'Nu', logo: 'üíú' };
            
            return { name: 'Otro Banco', logo: 'üèõÔ∏è' };
        }

        // Formatear tama√±o
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Actualizar visualizaci√≥n
        function updateFilesDisplay() {
            const queue = document.getElementById('filesQueue');
            const queueList = document.getElementById('filesQueueList');
            const processBtn = document.getElementById('processAllBtn');

            if (fileQueue.length === 0) {
                queue.style.display = 'none';
                processBtn.disabled = true;
                processBtn.textContent = '‚ö° Sin archivos para procesar';
                return;
            }

            queue.style.display = 'block';
            
            queueList.innerHTML = fileQueue.map(file => `
                <div class="file-item">
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 10px;">
                        <span>${getFileIcon(file.name)}</span>
                        <div>
                            <div>${file.name}</div>
                            <div style="font-size: 0.8rem; color: #718096;">
                                ${file.bank.logo} ${file.bank.name}
                            </div>
                        </div>
                    </div>
                    <div>${file.size}</div>
                    <div class="file-status status-${file.status}" style="padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; text-align: center;">
                        ${getStatusText(file.status)}
                    </div>
                    <div class="file-progress">
                        <div class="progress-bar" style="width: ${file.progress}%"></div>
                    </div>
                    <button onclick="removeFile(${file.id})" style="background: #fed7d7; color: #e53e3e; border: none; padding: 5px 10px; border-radius: 50%; cursor: pointer;">√ó</button>
                </div>
            `).join('');

            // Actualizar bot√≥n
            const pendingFiles = fileQueue.filter(f => f.status === 'pending').length;
            processBtn.disabled = pendingFiles === 0;
            processBtn.textContent = pendingFiles > 0 ? 
                `‚ö° Procesar ${pendingFiles} Archivo${pendingFiles > 1 ? 's' : ''}` : 
                '‚ö° Sin archivos para procesar';
        }

        // Funciones auxiliares
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = { 'pdf': 'üìÑ', 'xlsx': 'üìä', 'xls': 'üìä', 'csv': 'üìã' };
            return icons[ext] || 'üìÑ';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Pendiente',
                'processing': 'Procesando',
                'completed': 'Completado',
                'error': 'Error'
            };
            return texts[status] || 'Desconocido';
        }

        function removeFile(fileId) {
            fileQueue = fileQueue.filter(file => file.id !== fileId);
            updateFilesDisplay();
        }

        // Procesar todos los archivos
        async function processAllFiles() {
            const pendingFiles = fileQueue.filter(f => f.status === 'pending');
            
            if (pendingFiles.length === 0) {
                alert('No hay archivos para procesar');
                return;
            }

            // Limpiar transacciones anteriores
            transactionData.length = 0;
            
            for (const file of pendingFiles) {
                await processMultipleFile(file);
            }
            
            // Recalcular an√°lisis
            if (typeof analyzeData === 'function') {
                analyzeData();
            }
            
            showSuccessMessage(`Procesados ${pendingFiles.length} archivos correctamente`);
        }

        // Procesar archivo individual
        async function processMultipleFile(fileItem) {
            fileItem.status = 'processing';
            fileItem.progress = 0;
            updateFilesDisplay();

            try {
                const file = fileItem.file;
                const ext = file.name.split('.').pop().toLowerCase();
                
                fileItem.progress = 25;
                updateFilesDisplay();
                
                if (ext === 'pdf') {
                    await processMultiplePDF(file);
                } else if (ext === 'xlsx' || ext === 'xls') {
                    await processMultipleExcel(file);
                } else if (ext === 'csv') {
                    await processMultipleCSV(file);
                }
                
                fileItem.progress = 100;
                fileItem.status = 'completed';
                
            } catch (error) {
                fileItem.status = 'error';
                console.error('Error:', error);
            }
            
            updateFilesDisplay();
        }

        // Procesadores espec√≠ficos para m√∫ltiples archivos
        async function processMultiplePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            
            // Usar procesador existente
            if (fullText.includes('BBVA')) {
                await processBBVAPDF(fullText);
            } else {
                await processGenericPDF(fullText);
            }
        }

        async function processMultipleExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
            
            for (let i = 1; i < jsonData.length; i++) {
                if (jsonData[i].length > 0) {
                    const transaction = parseTransaction(headers, jsonData[i]);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processMultipleCSV(file) {
            const text = await file.text();
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const transaction = parseTransaction(headers, values);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }
        // GASTOS MANUALES SIMPLIFICADOS PARA EL FLUJO
        function addQuickExpense() {
            const description = document.getElementById('quickExpenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
            const category = document.getElementById('quickExpenseCategory').value;

            // Validaciones
            if (!description) {
                showNotification('Por favor ingresa una descripci√≥n', 'error');
                document.getElementById('quickExpenseDescription').focus();
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Por favor ingresa un monto v√°lido', 'error');
                document.getElementById('quickExpenseAmount').focus();
                return;
            }
            
            if (!category) {
                showNotification('Por favor selecciona una categor√≠a', 'error');
                document.getElementById('quickExpenseCategory').focus();
                return;
            }

            // Crear gasto manual
            const expense = {
                id: `manual_${Date.now()}`,
                description: description,
                amount: amount,
                category: category,
                date: new Date(),
                isManual: true,
                source: 'Efectivo'
            };

            quickManualExpenses.push(expense);
            updateQuickExpensesList();
            clearQuickExpenseForm();
            
            showNotification(`Gasto de $${amount.toLocaleString()} agregado`, 'success');
        }

        // ACTUALIZAR LISTA DE GASTOS R√ÅPIDOS
        function updateQuickExpensesList() {
            const list = document.getElementById('quickExpensesList');
            
            if (quickManualExpenses.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #718096;">No hay gastos en efectivo agregados</div>';
                return;
            }

            const totalManual = quickManualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            list.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                    <h4 style="color: #667eea; margin: 0;">üíµ Gastos en Efectivo (${quickManualExpenses.length})</h4>
                    <div style="font-weight: bold; color: #667eea; font-size: 1.2rem;">Total: $${totalManual.toLocaleString()}</div>
                </div>
                ${quickManualExpenses.map((expense, index) => `
                    <div style="display: flex; justify-content: between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${expense.description}</div>
                            <div style="font-size: 0.8rem; color: #718096;">${expense.category}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-weight: bold; color: #667eea;">$${expense.amount.toLocaleString()}</div>
                            <button onclick="removeQuickExpense(${index})" style="background: #fed7d7; color: #e53e3e; border: none; padding: 5px 8px; border-radius: 50%; cursor: pointer; font-size: 0.8rem;">√ó</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // REMOVER GASTO R√ÅPIDO
        function removeQuickExpense(index) {
            quickManualExpenses.splice(index, 1);
            updateQuickExpensesList();
            showNotification('Gasto eliminado', 'success');
        }

        // LIMPIAR FORMULARIO R√ÅPIDO
        function clearQuickExpenseForm() {
            document.getElementById('quickExpenseDescription').value = '';
            document.getElementById('quickExpenseAmount').value = '';
            document.getElementById('quickExpenseCategory').value = '';
            document.getElementById('quickExpenseDescription').focus();
        }

        // OMITIR GASTOS MANUALES
        function skipManualExpenses() {
            proceedToConsolidated();
        }

        // PROCEDER AL AN√ÅLISIS CONSOLIDADO
        function proceedToConsolidated() {
            currentStep = 3;
            
            // Combinar todas las transacciones
            transactionData.length = 0;
            
            // Agregar transacciones de archivos
            allConsolidatedTransactions.forEach(t => {
                transactionData.push({...t, source: t.source || 'Bancario'});
            });
            
            // Agregar gastos manuales
            quickManualExpenses.forEach(expense => {
                transactionData.push({...expense, source: 'Efectivo'});
            });

            // Ocultar paso anterior
            document.getElementById('manualExpensesFlow').style.display = 'none';
            
            // Mostrar resultados consolidados
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            // Ejecutar an√°lisis
            analyzeData();
            
            // Mostrar informaci√≥n consolidada
            showConsolidatedInfo();
            
            showNotification('¬°An√°lisis consolidado completado!', 'success');
        }

        // MOSTRAR INFORMACI√ìN CONSOLIDADA
        function showConsolidatedInfo() {
            // Agregar un banner de informaci√≥n consolidada
            const resultsSection = document.getElementById('resultsSection');
            const consolidatedBanner = document.createElement('div');
            consolidatedBanner.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 30px;
                text-align: center;
            `;
            
            const banksList = processedFilesData.map(f => f.bank.name).join(', ');
            const manualTotal = quickManualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            consolidatedBanner.innerHTML = `
                <h3 style="margin: 0 0 15px 0; font-size: 1.5rem;">üìä An√°lisis Financiero Consolidado</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;">${processedFilesData.length}</div>
                        <div style="opacity: 0.9;">Estado${processedFilesData.length > 1 ? 's' : ''} de Cuenta</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${banksList}</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;">${quickManualExpenses.length}</div>
                        <div style="opacity: 0.9;">Gastos en Efectivo</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">$${manualTotal.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;">${transactionData.length}</div>
                        <div style="opacity: 0.9;">Transacciones Totales</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">An√°lisis Completo</div>
                    </div>
                </div>
            `;
            
            resultsSection.insertBefore(consolidatedBanner, resultsSection.firstChild);
        }
</script>
    <!-- MODAL DE APRENDIZAJE -->
    <div id="learningModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üß† Ayuda al sistema a aprender</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #4a5568;">
                Encontramos algunas transacciones que no pudimos categorizar autom√°ticamente. 
                ¬øPuedes ayudarnos a mejorar?
            </p>
            
            <div id="learningTransactions"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="finishLearning" class="btn">Continuar con el an√°lisis</button>
            </div>
        </div>
    </div>
</body>
</html>
        
