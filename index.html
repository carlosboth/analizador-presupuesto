<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Presupuesto Personal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8f0ff);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #f0f4ff, #dde7ff);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e6f3ff, #cce7ff);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a5568;
            font-weight: 600;
        }

        .upload-hint {
            color: #718096;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .budget-section {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .budget-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .budget-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .budget-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: #2d3748;
        }

        .budget-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Analizador de Presupuesto Personal</h1>
            <p>Herramienta gratuita para analizar tus finanzas personales</p>
            <p style="font-size: 1rem; margin-top: 10px; opacity: 0.8;">
                Sube tu estado de cuenta y obt√©n un an√°lisis completo de tus gastos con recomendaciones personalizadas
            </p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Arrastra tu archivo aqu√≠ o haz clic para seleccionar</div>
                <div class="upload-hint">Soporta archivos Excel (.xlsx), CSV y PDF de bancos mexicanos</div>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Seleccionar Archivo
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv,.pdf">
            </div>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            <div>‚è≥ Procesando tu archivo...</div>
        </div>

        <div id="errorSection" class="error" style="display: none;"></div>
<div id="pendingSection" class="results-section" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <h2 style="color: #667eea; margin-bottom: 20px;">Archivo en proceso</h2>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    No pudimos procesar este estado de cuenta autom√°ticamente, pero estamos trabajando para soportar todos los bancos mexicanos.
                </p>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    D√©janos tu email y el nombre de tu banco, te notificaremos en 24-48h cuando tu reporte est√© listo.
                </p>
                <p style="font-size: 1rem; color: #718096; margin-bottom: 40px;">
                    <strong>¬°No necesitas volver a subir nada!</strong>
                </p>
            </div>

            <div style="max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                <script src="https://js.hsforms.net/forms/embed/50122034.js" defer></script>
                <div class="hs-form-frame" data-region="na1" data-form-id="7ba42206-42b9-4c9f-8d78-209b9166b526" data-portal-id="50122034"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" id="tryAnotherFile" 
                            style="background: none; border: none; color: #667eea; text-decoration: underline; cursor: pointer; font-size: 1rem;">
                        Probar con otro archivo
                    </button>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalExpenses">$0</div>
                    <div class="stat-label">Gastos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transacciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTransaction">$0</div>
                    <div class="stat-label">Gasto Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">Categor√≠a Principal</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Gastos por Categor√≠a</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Tendencia Mensual</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="budget-section">
                <div class="budget-title">üéØ Presupuesto Sugerido (Mensual)</div>
                <p style="text-align: center; margin-bottom: 20px; color: #4a5568;">
                    Basado en tu historial de gastos, con un objetivo de optimizaci√≥n del 10%
                </p>
                <div class="budget-categories" id="budgetCategories"></div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px;">
                <p style="color: #718096; font-size: 0.9rem;">
                    üí° <strong>Tip:</strong> Esta herramienta analiza tus patrones de gasto hist√≥ricos. 
                    Para mejores resultados, usa datos de al menos 3 meses.
                </p>
            </div>
        </div>
    </div>

    <script>
        let transactionData = [];
        let categoryChart = null;
        let trendChart = null;
        let pendingFileData = null;

        const categories = {
            'Alimentaci√≥n': ['supermercado', 'mercado', 'abarrotes', 'tienda', 'grocery', 'market', 'soriana', 'walmart', 'chedraui', 'oxxo', 'seven', '7-eleven', 'farmacia guadalajara', 'benavides', 'del rio', 'bodega aurrera', 'comercial mexicana', 'coppel'],
            'Restaurantes': ['restaurante', 'restaurant', 'comida', 'food', 'burger', 'pizza', 'taco', 'caf√©', 'coffee', 'bar', 'cantina', 'mc', 'kfc', 'subway', 'dominos', 'uber eats', 'rappi', 'didi food', 'sin delantal', 'starbucks', 'vips', 'sanborns', 'applebees', 'chilis'],
            'Transporte': ['gasolina', 'gas', 'uber', 'taxi', 'metro', 'autobus', 'bus', 'parking', 'estacionamiento', 'pemex', 'shell', 'bp', 'mobil', 'didi', 'beat', 'caseta', 'autopista', 'peaje'],
            'Entretenimiento': ['cine', 'cinema', 'netflix', 'spotify', 'juego', 'game', 'teatro', 'concierto', 'club', 'gym', 'deporte', 'cinepolis', 'cinemex', 'smart fit', 'sports world', 'disney', 'amazon prime', 'hbo'],
            'Servicios': ['luz', 'agua', 'gas', 'telefono', 'internet', 'cable', 'netflix', 'spotify', 'servicio', 'cfe', 'telmex', 'telcel', 'att', 'movistar', 'unefon', 'izzi', 'sky', 'dish', 'megacable'],
            'Salud': ['farmacia', 'hospital', 'doctor', 'medicina', 'dental', 'laboratorio', 'clinica', 'seguro', 'similares', 'guadalajara', 'benavides', 'del rio', 'issste', 'imss', 'medica sur', 'angeles'],
            'Compras': ['amazon', 'mercadolibre', 'liverpool', 'palacio', 'sears', 'tienda', 'ropa', 'zapatos', 'electronico', 'elektra', 'coppel', 'famsa', 'office depot', 'best buy', 'radioshack'],
            'Efectivo': ['atm', 'cajero', 'retiro', 'efectivo', 'cash', 'disposicion', 'retiro en cajero'],
            'Transferencias': ['spei enviado', 'transferencia', 'pago cuenta tercero', 'pago a tercero', 'envio', 'transferencia enviada'],
            'Otros': []
        };
        // Event listeners
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());

        document.getElementById('tryAnotherFile').addEventListener('click', resetUpload);

        // Drag and drop functions
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // UI state functions
        function showLoading() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorSection').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
            hideLoading();
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
            hideLoading();
        }

        function showPending() {
            document.getElementById('pendingSection').style.display = 'block';
            hideLoading();
        }

        function resetUpload() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            pendingFileData = null;
        }

        // Main file processing function
        async function processFile(file) {
            showLoading();
            
            try {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                if (fileExtension === 'csv') {
                    await processCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    await processExcel(file);
                } else if (fileExtension === 'pdf') {
                    await processPDF(file);
                } else {
                    throw new Error('Formato de archivo no soportado. Por favor usa CSV, Excel o PDF.');
                }
                
                if (transactionData.length === 0) {
                    pendingFileData = {
                        file: file,
                        fileName: file.name,
                        timestamp: new Date().toISOString(),
                        fileId: generateFileId()
                    };
                    
                    setTimeout(() => {
                        const hubspotForm = document.querySelector('.hs-form-frame iframe');
                        if (hubspotForm && hubspotForm.contentDocument) {
                            const fileIdField = hubspotForm.contentDocument.querySelector('input[name="file_id"]');
                            if (fileIdField) {
                                fileIdField.value = pendingFileData.fileId;
                            }
                        }
                    }, 2000);
                    
                    showPending();
                    return;
                }
                
                analyzeData();
                showResults();
                
            } catch (error) {
                pendingFileData = {
                    file: file,
                    fileName: file.name,
                    timestamp: new Date().toISOString(),
                    fileId: generateFileId(),
                    error: error.message
                };
                
                setTimeout(() => {
                    const hubspotForm = document.querySelector('.hs-form-frame iframe');
                    if (hubspotForm && hubspotForm.contentDocument) {
                        const fileIdField = hubspotForm.contentDocument.querySelector('input[name="file_id"]');
                        if (fileIdField) {
                            fileIdField.value = pendingFileData.fileId;
                        }
                    }
                }, 2000);
                
                showPending();
            }
        }

        function generateFileId() {
            return 'file_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }
        // File processing functions
        async function processCSV(file) {
            const text = await file.text();
            const lines = text.split('\n');
            
            if (lines.length < 2) {
                throw new Error('El archivo CSV debe tener al menos una l√≠nea de encabezado y una de datos.');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            transactionData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const transaction = parseTransaction(headers, values);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
                throw new Error('El archivo Excel debe tener al menos una l√≠nea de encabezado y una de datos.');
            }
            
            const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
            transactionData = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                if (jsonData[i].length > 0) {
                    const transaction = parseTransaction(headers, jsonData[i]);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('Texto extra√≠do del PDF:', fullText.substring(0, 500) + '...');
                
                if (fullText.includes('BBVA') || fullText.includes('bbva')) {
                    await processBBVAPDF(fullText);
                } else if (fullText.includes('Nu M√©xico') || fullText.includes('Cuenta Nu')) {
                    await processNuPDF(fullText);
                } else if (fullText.includes('Santander') || fullText.includes('SANTANDER')) {
                    await processSantanderPDF(fullText);
                } else if (fullText.includes('Banorte') || fullText.includes('BANORTE')) {
                    await processBanortePDF(fullText);
                } else {
                    await processGenericPDF(fullText);
                }
                
            } catch (error) {
                console.error('Error procesando PDF:', error);
                throw new Error('Error al procesar el PDF. Aseg√∫rate de que sea un estado de cuenta v√°lido.');
            }
        }
        // Bank-specific PDF processors
        async function processBBVAPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePattern = /(\d{1,2}\/[A-Z]{3})/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                const dateMatch = line.match(datePattern);
                if (dateMatch) {
                    const parts = line.split(' ');
                    if (parts.length >= 3) {
                        const fecha = parts[0];
                        const descripcion = parts.slice(1, -1).join(' ');
                        const montoStr = parts[parts.length - 1];
                        
                        const amount = parseFloat(montoStr.replace(/[,$]/g, ''));
                        
                        if (!isNaN(amount) && amount > 0 && isExpenseTransaction(descripcion)) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: parseBBVADate(fecha),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`BBVA: Procesadas ${transactionData.length} transacciones`);
        }

        async function processNuPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const transactionPattern = /(\d{1,2} [A-Z]{3} \d{4})\s+(.+?)\s+([-+]?\$?[\d,]+\.?\d*)/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                const match = line.match(transactionPattern);
                if (match) {
                    const [_, fecha, descripcion, montoStr] = match;
                    
                    let amount = parseFloat(montoStr.replace(/[$,\s-]/g, ''));
                    
                    const isNegative = montoStr.includes('-');
                    if (isNegative && amount > 0) {
                        if (isExpenseTransaction(descripcion)) {
                            const transaction = {
                                description: descripcion.trim(),
                                amount: amount,
                                date: parseNuDate(fecha),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Nu: Procesadas ${transactionData.length} transacciones`);
        }

        async function processSantanderPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePattern = /(\d{2}\/\d{2}\/\d{4})/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (datePattern.test(line) && line.includes('$')) {
                    const parts = line.split(/\s+/);
                    const fecha = parts.find(part => datePattern.test(part));
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (fecha && montoMatch) {
                        const descripcion = line.replace(fecha, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0 && isExpenseTransaction(descripcion)) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(fecha),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Santander: Procesadas ${transactionData.length} transacciones`);
        }

        async function processBanortePDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePattern = /(\d{2}-\d{2}-\d{4}|\d{2}\/\d{2}\/\d{4})/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (datePattern.test(line) && line.includes('$')) {
                    const parts = line.split(/\s+/);
                    const fecha = parts.find(part => datePattern.test(part));
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (fecha && montoMatch) {
                        const descripcion = line.replace(fecha, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0 && isExpenseTransaction(descripcion)) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(fecha.replace(/-/g, '/')),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Banorte: Procesadas ${transactionData.length} transacciones`);
        }

        async function processGenericPDF(text) {
            const lines = text.split('\n');
            transactionData = [];
            
            const datePatterns = [
                /(\d{1,2}\/\d{1,2}\/\d{4})/,
                /(\d{1,2}-\d{1,2}-\d{4})/,
                /(\d{1,2} [A-Z]{3} \d{4})/,
                /(\d{1,2}\/[A-Z]{3}\/\d{4})/
            ];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                let dateFound = null;
                for (const pattern of datePatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        dateFound = match[1];
                        break;
                    }
                }
                
                if (dateFound && line.includes('$')) {
                    const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (montoMatch) {
                        const descripcion = line.replace(dateFound, '').replace(montoMatch[0], '').trim();
                        const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                        
                        if (!isNaN(amount) && amount > 0 && descripcion.length > 5) {
                            const transaction = {
                                description: descripcion,
                                amount: amount,
                                date: new Date(dateFound),
                                category: categorizeTransaction(descripcion)
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
            
            console.log(`Gen√©rico: Procesadas ${transactionData.length} transacciones`);
        }
        // Utility functions
        function parseNuDate(dateStr) {
            const parts = dateStr.split(' ');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const monthStr = parts[1];
                const year = parseInt(parts[2]);
                
                const monthMap = {
                    'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                    'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
                };
                
                const month = monthMap[monthStr];
                if (month !== undefined) {
                    return new Date(year, month, day);
                }
            }
            
            return new Date();
        }

        function parseTransaction(headers, values) {
            const transaction = {};
            
            const descriptionFields = ['descripcion', 'descripci√≥n', 'concepto', 'description', 'merchant', 'comercio', 'movimiento'];
            const amountFields = ['monto', 'importe', 'amount', 'cantidad', 'cargo', 'abono', 'importe neto'];
            const dateFields = ['fecha', 'date', 'dia'];
            
            let description = '';
            let amount = 0;
            let date = new Date();
            
            headers.forEach((header, index) => {
                const value = values[index];
                const headerLower = String(header || '').toLowerCase().trim();
                
                if (descriptionFields.some(field => headerLower.includes(field))) {
                    description = String(value || '');
                }
                
                if (amountFields.some(field => headerLower.includes(field))) {
                    const cleanValue = String(value || '0').replace(/[,$\s]/g, '');
                    const numValue = parseFloat(cleanValue);
                    if (!isNaN(numValue) && Math.abs(numValue) > Math.abs(amount)) {
                        amount = numValue;
                    }
                }
                
                if (dateFields.some(field => headerLower.includes(field))) {
                    const dateValue = parseBBVADate(value);
                    if (dateValue && !isNaN(dateValue.getTime())) {
                        date = dateValue;
                    }
                }
            });
            
            if (description && Math.abs(amount) > 0 && isExpenseTransaction(description)) {
                return {
                    description: description,
                    amount: Math.abs(amount),
                    date: date,
                    category: categorizeTransaction(description)
                };
            }
            
            return null;
        }

        function parseBBVADate(dateStr) {
            if (!dateStr) return new Date();
            
            const str = String(dateStr).trim();
            
            if (str.includes('/') && str.length <= 10) {
                const parts = str.split('/');
                if (parts.length === 2) {
                    const day = parseInt(parts[0]);
                    const monthStr = parts[1].toUpperCase();
                    
                    const monthMap = {
                        'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                        'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
                    };
                    
                    const month = monthMap[monthStr];
                    if (month !== undefined && day >= 1 && day <= 31) {
                        const currentYear = new Date().getFullYear();
                        return new Date(currentYear, month, day);
                    }
                }
            }
            
            const standardDate = new Date(dateStr);
            if (!isNaN(standardDate.getTime())) {
                return standardDate;
            }
            
            return new Date();
        }

        function isExpenseTransaction(description) {
            const desc = description.toLowerCase();
            
            const incomeKeywords = [
                'spei recibido', 'deposito', 'dep√≥sito', 'transferencia recibida',
                'pago de nomina', 'n√≥mina', 'salario', 'sueldo', 'abono',
                'intereses', 'rendimiento', 'devolucion', 'devoluci√≥n',
                'reembolso', 'cashback'
            ];
            
            for (const keyword of incomeKeywords) {
                if (desc.includes(keyword)) {
                    return false;
                }
            }
            
            return true;
        }

        function categorizeTransaction(description) {
            const desc = description.toLowerCase();
            
            for (const [category, keywords] of Object.entries(categories)) {
                if (category === 'Otros') continue;
                
                for (const keyword of keywords) {
                    if (desc.includes(keyword)) {
                        return category;
                    }
                }
            }
            
            return 'Otros';
        }
        // Analysis and visualization functions
        function analyzeData() {
            const totalExpenses = transactionData.reduce((sum, t) => sum + t.amount, 0);
            const totalTransactions = transactionData.length;
            const avgTransaction = totalExpenses / totalTransactions;
            
            const categoryTotals = {};
            transactionData.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });
            
            const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b
            );
            
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toLocaleString()}`;
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('avgTransaction').textContent = `$${avgTransaction.toLocaleString()}`;
            document.getElementById('topCategory').textContent = topCategory;
            
            createCategoryChart(categoryTotals);
            createTrendChart();
            createBudgetSuggestions(categoryTotals, totalExpenses);
        }

        function createCategoryChart(categoryTotals) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        data: Object.values(categoryTotals),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const monthlyData = {};
            transactionData.forEach(t => {
                const monthKey = t.date.toISOString().substring(0, 7);
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + t.amount;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const date = new Date(month + '-01');
                        return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                    }),
                    datasets: [{
                        label: 'Gastos Mensuales',
                        data: sortedMonths.map(month => monthlyData[month]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBudgetSuggestions(categoryTotals, totalExpenses) {
            const budgetContainer = document.getElementById('budgetCategories');
            budgetContainer.innerHTML = '';
            
            const improvementFactor = 0.9;
            
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const suggestedAmount = Math.round(amount * improvementFactor);
                const percentage = ((amount / totalExpenses) * 100).toFixed(1);
                
                const budgetItem = document.createElement('div');
                budgetItem.className = 'budget-item';
                budgetItem.innerHTML = `
                    <div>
                        <div class="category-name">${category}</div>
                        <div style="font-size: 0.9rem; color: #718096;">${percentage}% del total</div>
                    </div>
                    <div class="budget-amount">$${suggestedAmount.toLocaleString()}</div>
                `;
                
                budgetContainer.appendChild(budgetItem);
            });
        }
    </script>
</body>
</html>
        
