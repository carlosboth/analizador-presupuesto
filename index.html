<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyVault - Analizador de Presupuesto Personal</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://unpkg.com/tailwindcss@^3/dist/tailwind.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
          
    <style>
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes blurIn { from { opacity: 0; filter: blur(8px); transform: scale(0.95); } to { opacity: 1; filter: blur(0); transform: scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        .animate-slide-in-left { animation: slideInLeft 0.8s ease-out forwards; }
        .animate-slide-in-right { animation: slideInRight 0.8s ease-out forwards; }
        .animate-blur-in { animation: blurIn 0.8s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        .delay-400 { animation-delay: 0.4s; }
        .delay-500 { animation-delay: 0.5s; }
        .delay-600 { animation-delay: 0.6s; }
        .delay-700 { animation-delay: 0.7s; }
        .delay-800 { animation-delay: 0.8s; }
        .delay-1000 { animation-delay: 1s; }
        .delay-1200 { animation-delay: 1.2s; }
        
        .initial-hidden { opacity: 0; }
        
        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .glow-purple { box-shadow: 0 0 20px rgba(147, 51, 234, 0.3); }
        .glow-orange { box-shadow: 0 0 20px rgba(249, 115, 22, 0.3); }
        
        .glass { backdrop-filter: blur(20px); background: rgba(17, 17, 17, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { backdrop-filter: blur(10px); background: rgba(23, 23, 23, 0.6); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        .gradient-green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .gradient-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .gradient-purple { background: linear-gradient(135deg, #9333ea, #7c3aed); }
        .gradient-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .gradient-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .gradient-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        
        .drag-over { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.1) !important; }
    </style>
</head>
<body class="bg-black text-white overflow-x-hidden">
    
    <!-- Main Container -->
    <div class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="text-center mb-12 animate-fade-in-up">
                <h1 class="text-4xl md:text-6xl font-bold mb-4 bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 bg-clip-text text-transparent">
                    üí∞ MoneyVault
                </h1>
                <p class="text-gray-400 text-lg md:text-xl">
                    An√°lisis inteligente de tu presupuesto personal
                </p>
                <div class="flex items-center justify-center gap-2 mt-4">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-xs text-green-400">Sistema Activo</span>
                </div>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection" class="animate-slide-in-left delay-300 relative max-w-2xl mx-auto mb-12">
                <div class="absolute -inset-4 bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-3xl blur-lg animate-pulse-slow"></div>
                <div class="relative glass glow-green rounded-3xl p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 gradient-green rounded-2xl flex items-center justify-center mx-auto mb-4 animate-float">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">Sube tu Estado de Cuenta</h3>
                        <p class="text-gray-400 text-sm">
                            Soportamos PDF, Excel y CSV de todos los bancos mexicanos
                        </p>
                    </div>
                    
                    <div id="uploadArea" class="border-2 border-dashed border-gray-600 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-500/5">
                        <div class="space-y-4">
                            <div class="text-4xl animate-float delay-500">üìä</div>
                            <div>
                                <p class="text-lg font-medium">Arrastra tu archivo aqu√≠</p>
                                <p class="text-gray-400 text-sm mt-2">o haz clic para seleccionar</p>
                            </div>
                            <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-500">
                                <span class="px-2 py-1 bg-gray-800 rounded">PDF</span>
                                <span class="px-2 py-1 bg-gray-800 rounded">XLSX</span>
                                <span class="px-2 py-1 bg-gray-800 rounded">CSV</span>
                            </div>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" class="hidden" accept=".pdf,.xlsx,.xls,.csv">
                    
                    <div class="flex justify-center mt-6">
                        <button onclick="document.getElementById('fileInput').click()" class="px-6 py-3 gradient-blue rounded-xl font-medium hover:scale-105 transition-transform flex items-center gap-2">
                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                            Seleccionar Archivo
                        </button>
                    </div>
                </div>
            </div>

<!-- CONTIN√öA AQU√ç LA SECCI√ìN 2: FORMULARIOS Y ESTADOS -->
            
            <!-- File Selected Section -->
            <div id="fileSection" class="animate-fade-in-up delay-600 relative max-w-2xl mx-auto mb-12 hidden">
                <div class="absolute -inset-4 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-3xl blur-lg animate-pulse-slow"></div>
                <div class="relative glass glow-blue rounded-3xl p-8">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold mb-2">Archivo Seleccionado</h3>
                        <p class="text-gray-400 text-sm">Listo para procesar</p>
                    </div>
                    
                    <div id="fileInfo" class="glass-card rounded-2xl p-6 mb-6">
                        <!-- File info will be populated here -->
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="processBtn" onclick="processFile()" class="px-8 py-4 gradient-green rounded-xl font-medium hover:scale-105 transition-transform flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i>
                            Procesar Archivo
                        </button>
                        <button onclick="clearFile()" class="px-6 py-4 glass-card rounded-xl font-medium hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Section -->
           <!-- Loading Section -->
            <div id="loadingSection" class="animate-blur-in relative max-w-2xl mx-auto mb-12 hidden">
                <div class="absolute -inset-4 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-3xl blur-lg animate-pulse-slow"></div>
                <div class="relative glass glow-purple rounded-3xl p-8 text-center">
                    <!-- Spinner principal -->
                    <div class="w-16 h-16 mx-auto mb-6 relative">
                        <div class="w-16 h-16 border-4 border-purple-400/20 rounded-full"></div>
                        <div class="w-16 h-16 border-4 border-purple-400 border-t-transparent rounded-full animate-spin absolute top-0 left-0"></div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-2">Analizando tu archivo...</h3>
                    <p class="text-gray-400 text-sm mb-6">
                        Nuestro motor de IA est√° procesando tus transacciones
                    </p>
                    
                    <!-- Barra de progreso animada -->
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full animate-pulse" style="width: 65%;"></div>
                    </div>
                    
                    <!-- Puntos de carga modernos -->
                    <div class="flex justify-center space-x-1">
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.3s;"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>
                    <h3 class="text-xl font-semibold mb-2">Analizando tu archivo...</h3>
                    <p class="text-gray-400 text-sm mb-4">
                        Nuestro motor de IA est√° procesando tus transacciones
                    </p>
                    <div class="flex justify-center">
                        <div class="flex space-x-2">
                            <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce"></div>
                            <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="animate-slide-in-right relative max-w-2xl mx-auto mb-12 hidden">
                <div class="absolute -inset-4 bg-gradient-to-r from-red-500/20 to-orange-500/20 rounded-3xl blur-lg"></div>
                <div class="relative glass border-red-500/20 rounded-3xl p-8 text-center">
                    <div class="w-16 h-16 gradient-red rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2 text-red-400">Error al procesar</h3>
                    <p id="errorMessage" class="text-gray-400 text-sm mb-6">
                        <!-- Error message will be populated here -->
                    </p>
                    <button onclick="resetToUpload()" class="px-6 py-3 gradient-blue rounded-xl font-medium hover:scale-105 transition-transform">
                        Intentar de nuevo
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="animate-fade-in-up delay-800 hidden">
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                    <div class="glass-card rounded-2xl p-6 hover:bg-white/10 transition-all animate-slide-in-left delay-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 gradient-green rounded-xl flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Ingresos</p>
                                <p class="text-2xl font-semibold" id="totalIngresos">$0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 hover:bg-white/10 transition-all animate-slide-in-left delay-400">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 gradient-red rounded-xl flex items-center justify-center">
                                <i data-lucide="trending-down" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Gastos</p>
                                <p class="text-2xl font-semibold" id="totalExpenses">$0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 hover:bg-white/10 transition-all animate-slide-in-left delay-500">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 gradient-blue rounded-xl flex items-center justify-center">
                                <i data-lucide="piggy-bank" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Ahorro</p>
                                <p class="text-2xl font-semibold" id="ahorroReal">$0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 hover:bg-white/10 transition-all animate-slide-in-left delay-600">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center">
                                <i data-lucide="percent" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">% Ahorro</p>
                                <p class="text-2xl font-semibold" id="porcentajeAhorro">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <!-- Pie Chart -->
                    <div class="glass-card rounded-3xl p-8 animate-slide-in-left delay-700">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold">Gastos por Categor√≠a</h3>
                            <div class="flex items-center gap-1">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-xs text-green-400">Live</span>
                            </div>
                        </div>
                        <div class="relative h-80">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Line Chart -->
                    <div class="glass-card rounded-3xl p-8 animate-slide-in-right delay-800">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold">Tendencia Mensual</h3>
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i>
                                <span class="text-xs text-blue-400">An√°lisis</span>
                            </div>
                        </div>
                        <div class="relative h-80">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Budget Recommendations -->
                <div class="glass-card rounded-3xl p-8 mb-12 animate-fade-in-up delay-1000">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center">
                            <i data-lucide="target" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">Presupuesto Sugerido</h3>
                            <p class="text-gray-400 text-sm">Optimizaci√≥n inteligente basada en IA</p>
                        </div>
                    </div>
                    
                    <div id="budgetCategories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Budget items will be populated here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center animate-fade-in-up delay-1200">
                    <button onclick="resetToUpload()" class="px-8 py-4 glass-card rounded-xl font-medium hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Analizar Otro Archivo
                    </button>
                    <button onclick="exportResults()" class="px-8 py-4 gradient-cyan rounded-xl font-medium hover:scale-105 transition-transform flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Exportar Resultados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Notifications will be added here -->
    </div>

<!-- CONTIN√öA AQU√ç LA SECCI√ìN 3: JAVASCRIPT PRINCIPAL -->
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ MoneyVault - Inicializando...');
            lucide.createIcons();
            initFileHandling();
            
            // PDF.js setup
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        });

        // Global variables
        let transactionData = [];
        let categoryChart = null;
        let trendChart = null;
        let selectedFile = null;

        // Categories for analysis
        const categories = {
            'Ingresos': [
                'spei recibido', 'deposito', 'dep√≥sito', 'transferencia recibida', 
                'pago de nomina', 'n√≥mina', 'salario', 'sueldo', 'abono', 'intereses', 
                'rendimiento', 'cashback', 'reembolso', 'devoluci√≥n'
            ],
            'Alimentaci√≥n': [
                'supermercado', 'mercado', 'abarrotes', 'tienda', 'grocery', 
                'soriana', 'walmart', 'chedraui', 'oxxo', 'seven', '7-eleven', 
                'farmacia guadalajara', 'benavides', 'bodega aurrera'
            ],
            'Restaurantes': [
                'restaurante', 'restaurant', 'comida', 'food', 'burger', 'pizza', 'taco', 
                'caf√©', 'coffee', 'bar', 'mc', 'kfc', 'subway', 'dominos', 
                'uber eats', 'rappi', 'didi food', 'starbucks', 'vips'
            ],
            'Transporte': [
                'gasolina', 'gas', 'uber', 'taxi', 'metro', 'autobus', 'parking', 
                'estacionamiento', 'pemex', 'shell', 'bp', 'mobil', 'didi', 'beat'
            ],
            'Entretenimiento': [
                'cine', 'cinema', 'netflix', 'spotify', 'juego', 'game', 'teatro', 
                'concierto', 'club', 'gym', 'deporte', 'cinepolis', 'cinemex'
            ],
            'Servicios': [
                'luz', 'agua', 'gas', 'telefono', 'internet', 'cable', 
                'cfe', 'telmex', 'telcel', 'att', 'movistar', 'izzi', 'sky'
            ],
            'Salud': [
                'farmacia', 'hospital', 'doctor', 'medicina', 'dental', 'laboratorio', 
                'clinica', 'seguro', 'similares', 'issste', 'imss'
            ],
            'Compras': [
                'amazon', 'mercadolibre', 'liverpool', 'palacio', 'sears', 'tienda', 
                'ropa', 'zapatos', 'electronico', 'elektra', 'coppel'
            ],
            'Efectivo': [
                'atm', 'cajero', 'retiro', 'efectivo', 'cash', 'disposicion'
            ],
            'Transferencias': [
                'spei enviado', 'transferencia', 'pago cuenta tercero', 'pago a tercero'
            ],
            'Otros': []
        };

        // File handling functions
        function initFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            // Drag & drop events
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('click', () => fileInput.click());

            // File selection
            fileInput.addEventListener('change', handleFileSelection);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleSingleFile(files[0]);
            }
        }

        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleSingleFile(files[0]);
            }
        }

        function handleSingleFile(file) {
            const validExtensions = ['pdf', 'xlsx', 'xls', 'csv'];
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(extension)) {
                showNotification(`Archivo ${file.name} no v√°lido. Solo PDF, Excel y CSV.`, 'error');
                return;
            }

            selectedFile = {
                file: file,
                name: file.name,
                size: formatFileSize(file.size),
                bank: detectBank(file.name)
            };

            displaySelectedFile();
            showSection('fileSection');
            showNotification('Archivo cargado correctamente', 'success');
        }

        // Utility functions
        function detectBank(fileName) {
            const name = fileName.toLowerCase();
            
            if (name.includes('bbva')) return { name: 'BBVA', logo: 'üè¶', color: 'blue' };
            if (name.includes('santander')) return { name: 'Santander', logo: 'üî¥', color: 'red' };
            if (name.includes('banorte')) return { name: 'Banorte', logo: 'üü†', color: 'orange' };
            if (name.includes('nu')) return { name: 'Nu', logo: 'üíú', color: 'purple' };
            if (name.includes('hsbc')) return { name: 'HSBC', logo: '‚ö™', color: 'gray' };
            if (name.includes('banamex')) return { name: 'Banamex', logo: 'üîµ', color: 'blue' };
            
            return { name: 'Otro Banco', logo: 'üèõÔ∏è', color: 'gray' };
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = { 
                'pdf': 'üìÑ', 
                'xlsx': 'üìä', 
                'xls': 'üìä', 
                'csv': 'üìã' 
            };
            return icons[ext] || 'üìÑ';
        }

        function displaySelectedFile() {
            const fileInfo = document.getElementById('fileInfo');
            const icon = getFileIcon(selectedFile.name);
            
            fileInfo.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-3xl">${icon}</div>
                        <div>
                            <p class="font-semibold">${selectedFile.name}</p>
                            <p class="text-sm text-gray-400">${selectedFile.size}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-2 glass-card rounded-lg">
                        <span class="text-lg">${selectedFile.bank.logo}</span>
                        <span class="text-sm font-medium">${selectedFile.bank.name}</span>
                    </div>
                </div>
            `;
        }

        // UI Management functions
        function showSection(sectionId) {
            // Hide all sections
            const sections = ['uploadSection', 'fileSection', 'loadingSection', 'errorSection', 'resultsSection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            showSection('uploadSection');
            showNotification('Archivo eliminado', 'success');
        }

        function resetToUpload() {
            // Clear all data
            transactionData = [];
            selectedFile = null;
            
            // Destroy charts
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Show upload section
            showSection('uploadSection');
            showNotification('Listo para analizar un nuevo archivo', 'success');
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const bgColors = {
                'success': 'gradient-green',
                'error': 'gradient-red',
                'warning': 'gradient-orange',
                'info': 'gradient-blue'
            };
            
            const icons = {
                'success': 'check-circle',
                'error': 'x-circle',
                'warning': 'alert-triangle',
                'info': 'info'
            };
            
            notification.className = `glass-card rounded-xl p-4 transform translate-x-full transition-transform duration-300 flex items-center gap-3 ${bgColors[type] || 'gradient-blue'}`;
            notification.innerHTML = `
                <i data-lucide="${icons[type] || 'info'}" class="w-5 h-5 text-white"></i>
                <span class="text-white font-medium">${message}</span>
            `;
            
            container.appendChild(notification);
            lucide.createIcons();
            
            // Show notification
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Hide and remove notification
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // File processing functions
       // ===================
// INTEGRACI√ìN DEL SISTEMA MODULAR
// Reemplaza tu funci√≥n processFile() actual con esta versi√≥n
// ===================

// Instancia global del consolidador
let bankConsolidator = new BankConsolidator();

// NUEVA funci√≥n processFile() que reemplaza la anterior
async function processFile() {
    if (!selectedFile) {
        showNotification('No hay archivo seleccionado', 'error');
        return;
    }

    showSection('loadingSection');
    
    try {
        console.log(`üîÑ Iniciando procesamiento: ${selectedFile.name}`);
        
        // Procesar con el sistema modular
        const result = await bankConsolidator.processFile(selectedFile.file);
        
        if (result.success && result.count > 0) {
            // Obtener reporte consolidado
            const report = bankConsolidator.getConsolidatedReport();
            
            // Actualizar variable global para compatibilidad
            transactionData = report.allTransactions;
            
            // Mostrar resultados mejorados
            displayModularResults(report);
            showSection('resultsSection');
            
            showNotification(
                `‚úÖ ${result.bankName}: ${result.count} transacciones procesadas`, 
                'success'
            );
            
            console.log('üìä Reporte consolidado:', report.summary);
            
        } else if (result.success && result.count === 0) {
            throw new Error('No se encontraron transacciones v√°lidas en el archivo');
        } else {
            throw new Error(result.error || 'Error desconocido al procesar el archivo');
        }
        
    } catch (error) {
        console.error('‚ùå Error en processFile:', error);
        document.getElementById('errorMessage').textContent = error.message;
        showSection('errorSection');
        showNotification('Error al procesar el archivo', 'error');
    }
}

// Nueva funci√≥n para mostrar resultados con informaci√≥n de bancos
function displayModularResults(report) {
    const { summary, categoryTotals, bankStats, processedFiles } = report;
    
    // Actualizar tarjetas b√°sicas
    updateElement('totalIngresos', formatCurrency(summary.totalIngresos));
    updateElement('totalExpenses', formatCurrency(summary.totalGastos));
    updateElement('ahorroReal', formatCurrency(summary.ahorroReal));
    updateElement('porcentajeAhorro', `${summary.porcentajeAhorro.toFixed(1)}%`);
    
    // Agregar informaci√≥n de bancos procesados
    addBankSummarySection(summary, bankStats, processedFiles);
    
    // Crear gr√°ficas est√°ndar
    createCategoryChart(categoryTotals);
    createTrendChart();
    createBudgetSuggestions(categoryTotals, summary.totalGastos, summary.totalIngresos);
    
    // Si hay m√∫ltiples bancos, mostrar comparaci√≥n
    if (Object.keys(bankStats).length > 1) {
        createBankComparisonSection(bankStats);
    }
}

// Agregar secci√≥n de resumen de bancos
function addBankSummarySection(summary, bankStats, processedFiles) {
    // Buscar si ya existe la secci√≥n
    let bankSummary = document.getElementById('bankSummary');
    
    if (!bankSummary) {
        // Crear nueva secci√≥n
        bankSummary = document.createElement('div');
        bankSummary.id = 'bankSummary';
        bankSummary.className = 'glass-card rounded-2xl p-6 mb-8 animate-fade-in-up';
        
        // Insertar antes de las tarjetas de estad√≠sticas
        const statsGrid = document.querySelector('.stats-grid');
        statsGrid.parentNode.insertBefore(bankSummary, statsGrid);
    }
    
    // Generar lista de bancos
    const bankList = Object.entries(bankStats).map(([bank, stats]) => 
        `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-500/20 text-blue-300">
            ${getBankIcon(bank)} ${bank}: ${stats.count} transacciones
        </span>`
    ).join('');
    
    bankSummary.innerHTML = `
        <div class="text-center">
            <h3 class="text-xl font-semibold mb-4 flex items-center justify-center gap-2">
                <i data-lucide="building-2" class="w-5 h-5 text-blue-400"></i>
                Resumen Multi-Banco
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">${summary.filesProcessed}</div>
                    <div class="text-sm text-gray-400">Archivos Procesados</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">${summary.banksProcessed}</div>
                    <div class="text-sm text-gray-400">Bancos Detectados</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400">${summary.totalTransactions}</div>
                    <div class="text-sm text-gray-400">Total Transacciones</div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center gap-2">
                ${bankList}
            </div>
        </div>
    `;
    
    // Actualizar √≠conos
    lucide.createIcons();
}

// Funci√≥n para obtener √≠cono del banco
function getBankIcon(bankName) {
    const icons = {
        'BBVA': 'üè¶',
        'Santander': 'üî¥',
        'Nu': 'üíú',
        'Banorte': 'üü†',
        'Banamex': 'üîµ',
        'HSBC': '‚ö™',
        'Gen√©rico': 'üèõÔ∏è'
    };
    return icons[bankName] || 'üèõÔ∏è';
}

// Crear secci√≥n de comparaci√≥n entre bancos
function createBankComparisonSection(bankStats) {
    let bankComparison = document.getElementById('bankComparison');
    
    if (!bankComparison) {
        bankComparison = document.createElement('div');
        bankComparison.id = 'bankComparison';
        bankComparison.className = 'glass-card rounded-3xl p-8 mb-8 animate-fade-in-up';
        
        // Insertar despu√©s de las gr√°ficas principales
        const chartsContainer = document.querySelector('.charts-container');
        chartsContainer.parentNode.insertBefore(bankComparison, chartsContainer.nextSibling);
    }
    
    bankComparison.innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold">Comparaci√≥n por Banco</h3>
            <div class="flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-4 h-4 text-green-400"></i>
                <span class="text-xs text-green-400">Multi-Banco</span>
            </div>
        </div>
        <div class="relative h-80">
            <canvas id="bankComparisonChart"></canvas>
        </div>
    `;
    
    // Crear gr√°fica de barras para comparar bancos
    createBankChart(bankStats);
    lucide.createIcons();
}

// Crear gr√°fica de comparaci√≥n de bancos
function createBankChart(bankStats) {
    const ctx = document.getElementById('bankComparisonChart');
    if (!ctx) return;
    
    const banks = Object.keys(bankStats);
    const transactionCounts = banks.map(bank => bankStats[bank].count);
    const totalAmounts = banks.map(bank => bankStats[bank].totalAmount);
    
    const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: banks.map(bank => `${getBankIcon(bank)} ${bank}`),
            datasets: [
                {
                    label: 'N√∫mero de Transacciones',
                    data: transactionCounts,
                    backgroundColor: colors.slice(0, banks.length).map(color => color + '80'),
                    borderColor: colors.slice(0, banks.length),
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'Monto Total',
                    data: totalAmounts,
                    backgroundColor: colors.slice(0, banks.length).map(color => color + '40'),
                    borderColor: colors.slice(0, banks.length),
                    borderWidth: 2,
                    type: 'line',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff',
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#ffffff',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            if (context.dataset.label === 'Monto Total') {
                                return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                            }
                            return `${context.dataset.label}: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#9ca3af' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { 
                        color: '#9ca3af',
                        callback: function(value) {
                            return value + ' transacciones';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { 
                        color: '#9ca3af',
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n mejorada para m√∫ltiples archivos
async function processMultipleFiles(files) {
    showSection('loadingSection');
    let successCount = 0;
    let totalTransactions = 0;
    
    try {
        console.log(`üìÅ Procesando ${files.length} archivos...`);
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            console.log(`üìÑ [${i + 1}/${files.length}] Procesando: ${file.name}`);
            
            const result = await bankConsolidator.processFile(file);
            
            if (result.success) {
                successCount++;
                totalTransactions += result.count;
                showNotification(
                    `‚úÖ ${result.bankName}: ${result.count} transacciones (${i + 1}/${files.length})`, 
                    'success'
                );
            } else {
                console.warn(`‚ö†Ô∏è Error en ${file.name}:`, result.error);
                showNotification(`‚ö†Ô∏è Error en ${file.name}`, 'warning');
            }
        }
        
        if (successCount > 0) {
            const report = bankConsolidator.getConsolidatedReport();
            transactionData = report.allTransactions;
            
            displayModularResults(report);
            showSection('resultsSection');
            
            showNotification(
                `üéâ Procesamiento completado: ${successCount}/${files.length} archivos, ${totalTransactions} transacciones`, 
                'success'
            );
        } else {
            throw new Error('No se pudo procesar ning√∫n archivo correctamente');
        }
        
    } catch (error) {
        console.error('‚ùå Error en procesamiento m√∫ltiple:', error);
        document.getElementById('errorMessage').textContent = error.message;
        showSection('errorSection');
        showNotification('Error al procesar los archivos', 'error');
    }
}

// Funci√≥n para resetear el consolidador
function resetBankConsolidator() {
    bankConsolidator.reset();
    transactionData = [];
    
    // Limpiar secciones adicionales
    const bankSummary = document.getElementById('bankSummary');
    const bankComparison = document.getElementById('bankComparison');
    
    if (bankSummary) bankSummary.remove();
    if (bankComparison) bankComparison.remove();
    
    console.log('üîÑ Consolidador reiniciado');
}

// Modificar resetToUpload para usar el nuevo sistema
function resetToUpload() {
    // Resetear consolidador
    resetBankConsolidator();
    
    // Limpiar archivo seleccionado
    selectedFile = null;
    
    // Destruir gr√°ficas existentes
    if (categoryChart) {
        categoryChart.destroy();
        categoryChart = null;
    }
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }
    
    // Resetear input de archivo
    document.getElementById('fileInput').value = '';
    
    // Mostrar secci√≥n de upload
    showSection('uploadSection');
    showNotification('Listo para analizar nuevos archivos', 'success');
}

// Funci√≥n de exportaci√≥n mejorada
function exportResults() {
    if (transactionData.length === 0) {
        showNotification('No hay datos para exportar', 'warning');
        return;
    }
    
    const report = bankConsolidator.getConsolidatedReport();
    
    const exportData = {
        fecha_analisis: new Date().toISOString(),
        resumen: report.summary,
        bancos_procesados: report.bankStats,
        archivos_procesados: report.processedFiles,
        categorias: report.categoryTotals,
        transacciones: report.allTransactions.map(t => ({
            id: t.id,
            fecha: t.date.toISOString().split('T')[0],
            descripcion: t.description,
            monto: t.amount,
            categoria: t.category,
            tipo: t.type,
            banco: t.source
        }))
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
        type: 'application/json' 
    });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis-consolidado-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Reporte consolidado exportado correctamente', 'success');
}

// Funciones de debug mejoradas
window.debugApp = {
    showTransactionData: () => console.table(transactionData),
    showBankStats: () => console.log(bankConsolidator.bankStats),
    showReport: () => console.log(bankConsolidator.getConsolidatedReport()),
    testNotification: (type) => showNotification(`Test ${type} notification`, type),
    resetApp: resetToUpload,
    processTestFile: async (fileName) => {
        // Funci√≥n para testing
        console.log(`üß™ Testing processor for: ${fileName}`);
    }
};

console.log('üîß Sistema modular integrado correctamente');
console.log('üí° Usa window.debugApp.showReport() para ver el reporte completo');
        // CSV Processing
        async function processCSV(file) {
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('El archivo CSV debe tener al menos una l√≠nea de encabezado y una de datos');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            transactionData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const transaction = parseTransaction(headers, values);
                if (transaction) {
                    transactionData.push(transaction);
                }
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Excel Processing
        async function processExcel(file) {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
                throw new Error('El archivo Excel debe tener al menos una l√≠nea de encabezado y una de datos');
            }
            
            const headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
            transactionData = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                if (jsonData[i] && jsonData[i].length > 0) {
                    const transaction = parseTransaction(headers, jsonData[i]);
                    if (transaction) {
                        transactionData.push(transaction);
                    }
                }
            }
        }

        // PDF Processing
        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            
            // Detect bank and process accordingly
            if (fullText.includes('BBVA') || fullText.includes('bbva')) {
                await processBBVAPDF(fullText);
            } else if (fullText.includes('Santander') || fullText.includes('SANTANDER')) {
                await processSantanderPDF(fullText);
            } else if (fullText.includes('Nu M√©xico') || fullText.includes('Cuenta Nu')) {
                await processNuPDF(fullText);
            } else if (fullText.includes('Banorte') || fullText.includes('BANORTE')) {
                await processBanortePDF(fullText);
            } else {
                await processGenericPDF(fullText);
            }
        }

        // CONTIN√öA EN SECCI√ìN 5: PROCESADORES ESPEC√çFICOS DE BANCOS
        // Bank-specific PDF processors
        async function processSantanderPDF(text) {
            transactionData = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line.length < 10) continue;
                
                // Pattern for Santander transactions: Date Description Amount
                const pattern = /(\d{2}-[A-Z]{3}-\d{4})\s+([^$]+)\$\s*([\d,]+\.?\d*)/;
                const match = line.match(pattern);
                
                if (match) {
                    const [_, dateStr, description, amountStr] = match;
                    const amount = parseFloat(amountStr.replace(/,/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        const transaction = {
                            description: description.trim(),
                            amount: amount,
                            date: parseSantanderDate(dateStr),
                            category: categorizeTransaction(description),
                            type: isIncome(description) ? 'INGRESO' : 'GASTO',
                            source: 'Santander'
                        };
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processBBVAPDF(text) {
            transactionData = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line.length < 10) continue;
                
                // Pattern for BBVA transactions
                const datePattern = /(\d{1,2}\/\d{1,2}\/\d{4})/;
                const amountPattern = /\$?([\d,]+\.?\d*)/;
                
                const dateMatch = line.match(datePattern);
                const amountMatch = line.match(amountPattern);
                
                if (dateMatch && amountMatch) {
                    const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
                    if (!isNaN(amount) && amount > 0) {
                        const description = line
                            .replace(dateMatch[0], '')
                            .replace(amountMatch[0], '')
                            .trim();
                        
                        if (description.length > 3) {
                            const transaction = {
                                description: description,
                                amount: amount,
                                date: new Date(dateMatch[1]),
                                category: categorizeTransaction(description),
                                type: isIncome(description) ? 'INGRESO' : 'GASTO',
                                source: 'BBVA'
                            };
                            transactionData.push(transaction);
                        }
                    }
                }
            }
        }

        async function processNuPDF(text) {
            transactionData = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line.length < 10) continue;
                
                // Nu Bank usually has simple format
                const pattern = /(\d{1,2}\/\d{1,2})\s+([^$]+)\s+\$?([\d,]+\.?\d*)/;
                const match = line.match(pattern);
                
                if (match) {
                    const [_, dateStr, description, amountStr] = match;
                    const amount = parseFloat(amountStr.replace(/,/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        const currentYear = new Date().getFullYear();
                        const [day, month] = dateStr.split('/');
                        const date = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                        
                        const transaction = {
                            description: description.trim(),
                            amount: amount,
                            date: date,
                            category: categorizeTransaction(description),
                            type: isIncome(description) ? 'INGRESO' : 'GASTO',
                            source: 'Nu'
                        };
                        transactionData.push(transaction);
                    }
                }
            }
        }

        async function processBanortePDF(text) {
            // Similar to other processors, implement Banorte-specific parsing
            await processGenericPDF(text);
        }

        async function processGenericPDF(text) {
            transactionData = [];
            const lines = text.split('\n');
            
            const datePatterns = [
                /(\d{1,2}\/\d{1,2}\/\d{4})/,
                /(\d{1,2}-\d{1,2}-\d{4})/,
                /(\d{1,2} [A-Z]{3} \d{4})/
            ];
            
            for (let line of lines) {
                line = line.trim();
                if (line.length < 10) continue;
                
                let dateFound = null;
                for (const pattern of datePatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        dateFound = match[1];
                        break;
                    }
                }
                
                if (dateFound && line.includes('$')) {
                    const amountMatch = line.match(/\$?([\d,]+\.?\d*)/);
                    
                    if (amountMatch) {
                        const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
                        if (!isNaN(amount) && amount > 0) {
                            const description = line
                                .replace(dateFound, '')
                                .replace(amountMatch[0], '')
                                .trim();
                            
                            if (description.length > 5) {
                                const transaction = {
                                    description: description,
                                    amount: amount,
                                    date: new Date(dateFound),
                                    category: categorizeTransaction(description),
                                    type: isIncome(description) ? 'INGRESO' : 'GASTO',
                                    source: 'Gen√©rico'
                                };
                                transactionData.push(transaction);
                            }
                        }
                    }
                }
            }
        }

        // Transaction parsing helpers
        function parseTransaction(headers, values) {
            const descriptionFields = ['descripcion', 'descripci√≥n', 'concepto', 'description', 'merchant', 'comercio', 'movimiento'];
            const amountFields = ['monto', 'importe', 'amount', 'cantidad', 'cargo', 'abono', 'importe neto'];
            const dateFields = ['fecha', 'date', 'dia'];
            
            let description = '';
            let amount = 0;
            let date = new Date();
            
            headers.forEach((header, index) => {
                const value = values[index];
                const headerLower = String(header || '').toLowerCase().trim();
                
                if (descriptionFields.some(field => headerLower.includes(field))) {
                    description = String(value || '').replace(/"/g, '');
                }
                
                if (amountFields.some(field => headerLower.includes(field))) {
                    const cleanValue = String(value || '0').replace(/[,$\s"]/g, '');
                    const numValue = parseFloat(cleanValue);
                    if (!isNaN(numValue) && Math.abs(numValue) > Math.abs(amount)) {
                        amount = numValue;
                    }
                }
                
                if (dateFields.some(field => headerLower.includes(field))) {
                    const dateValue = new Date(value);
                    if (dateValue && !isNaN(dateValue.getTime())) {
                        date = dateValue;
                    }
                }
            });
            
            if (description && Math.abs(amount) > 0) {
                return {
                    description: description,
                    amount: Math.abs(amount),
                    date: date,
                    category: categorizeTransaction(description),
                    type: isIncome(description) ? 'INGRESO' : 'GASTO',
                    source: 'CSV/Excel'
                };
            }
            
            return null;
        }

        function parseSantanderDate(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length !== 3) return new Date();
            
            const day = parseInt(parts[0]);
            const monthStr = parts[1];
            const year = parseInt(parts[2]);
            
            const monthMap = {
                'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
            };
            
            const month = monthMap[monthStr];
            return month !== undefined ? new Date(year, month, day) : new Date();
        }

        function isIncome(description) {
            const desc = description.toUpperCase();
            const incomeKeywords = [
                'ABONO', 'DEPOSITO', 'TRANSFERENCIA RECIBIDA', 'PAGO DE NOMINA',
                'N√ìMINA', 'SALARIO', 'SUELDO', 'INTERESES', 'RENDIMIENTO',
                'CASHBACK', 'REEMBOLSO', 'DEVOLUCI√ìN'
            ];
            
            return incomeKeywords.some(keyword => desc.includes(keyword));
        }

        function categorizeTransaction(description) {
            const desc = description.toLowerCase();
            
            for (const [category, keywords] of Object.entries(categories)) {
                if (category === 'Otros') continue;
                
                for (const keyword of keywords) {
                    if (desc.includes(keyword)) {
                        return category;
                    }
                }
            }
            
            return 'Otros';
        }

        // Data analysis functions
        function analyzeData() {
            if (transactionData.length === 0) return;
            
            const ingresos = transactionData.filter(t => t.category === 'Ingresos' || t.type === 'INGRESO');
            const gastos = transactionData.filter(t => t.category !== 'Ingresos' && t.type !== 'INGRESO');
            
            const totalIngresos = ingresos.reduce((sum, t) => sum + t.amount, 0);
            const totalGastos = gastos.reduce((sum, t) => sum + t.amount, 0);
            const ahorroReal = totalIngresos - totalGastos;
            const porcentajeAhorro = totalIngresos > 0 ? ((ahorroReal / totalIngresos) * 100) : 0;
            
            // Update summary cards
            updateElement('totalIngresos', formatCurrency(totalIngresos));
            updateElement('totalExpenses', formatCurrency(totalGastos));
            updateElement('ahorroReal', formatCurrency(ahorroReal));
            updateElement('porcentajeAhorro', `${porcentajeAhorro.toFixed(1)}%`);
            
            // Calculate category totals
            const categoryTotals = {};
            gastos.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });
            
            // Create charts
            createCategoryChart(categoryTotals);
            createTrendChart();
            createBudgetSuggestions(categoryTotals, totalGastos, totalIngresos);
            
            console.log('An√°lisis completado:', {
                transacciones: transactionData.length,
                ingresos: totalIngresos,
                gastos: totalGastos,
                ahorro: ahorroReal
            });
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Chart creation functions
        function createCategoryChart(categoryTotals) {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            
            const colors = [
                '#22c55e', '#3b82f6', '#f59e0b', '#ef4444',
                '#8b5cf6', '#06b6d4', '#f97316', '#84cc16',
                '#ec4899', '#64748b'
            ];
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                color: '#ffffff',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            // Group transactions by month
            const monthlyData = {};
            transactionData.forEach(t => {
                if (t.category !== 'Ingresos' && t.type !== 'INGRESO') {
                    const monthKey = t.date.toISOString().substring(0, 7);
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + t.amount;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthLabels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
            });
            const monthValues = sortedMonths.map(month => monthlyData[month]);
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Gastos Mensuales',
                        data: monthValues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Gastos: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBudgetSuggestions(categoryTotals, totalExpenses, totalIngresos) {
            const budgetContainer = document.getElementById('budgetCategories');
            if (!budgetContainer) return;
            
            budgetContainer.innerHTML = '';
            
            // Add financial health summary
            if (totalIngresos > 0) {
                const ratioGastos = ((totalExpenses / totalIngresos) * 100).toFixed(1);
                const ahorroSugerido = totalIngresos * 0.2;
                
                const summaryCard = document.createElement('div');
                summaryCard.className = 'glass-card rounded-2xl p-6 md:col-span-2 lg:col-span-3';
                summaryCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold mb-2">üìä Resumen Financiero</h4>
                            <p class="text-sm text-gray-400">
                                Gastas ${ratioGastos}% de tus ingresos
                                ${ratioGastos > 80 ? '‚ö†Ô∏è Riesgo alto' : ratioGastos > 60 ? '‚ö° Moderado' : '‚úÖ Saludable'}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">Ahorro sugerido</p>
                            <p class="text-xl font-semibold text-green-400">${formatCurrency(ahorroSugerido)}</p>
                        </div>
                    </div>
                `;
                budgetContainer.appendChild(summaryCard);
            }
            
            // Add category budget suggestions
            const improvementFactor = 0.9; // 10% reduction target
            
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const suggestedAmount = Math.round(amount * improvementFactor);
                const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
                const savings = amount - suggestedAmount;
                
                const categoryCard = document.createElement('div');
                categoryCard.className = 'glass-card rounded-2xl p-4 hover:bg-white/10 transition-all';
                categoryCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-medium">${category}</h4>
                        <span class="text-xs text-gray-400">${percentage}%</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Actual:</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Sugerido:</span>
                            <span class="text-green-400">${formatCurrency(suggestedAmount)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Ahorro:</span>
                            <span class="text-blue-400">${formatCurrency(savings)}</span>
                        </div>
                    </div>
                `;
                
                budgetContainer.appendChild(categoryCard);
            });
        }

        // Export functionality
        function exportResults() {
            if (transactionData.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            const exportData = {
                fecha_analisis: new Date().toISOString(),
                archivo_procesado: selectedFile ? selectedFile.name : 'Desconocido',
                resumen: {
                    total_transacciones: transactionData.length,
                    total_ingresos: transactionData.filter(t => t.category === 'Ingresos' || t.type === 'INGRESO').reduce((sum, t) => sum + t.amount, 0),
                    total_gastos: transactionData.filter(t => t.category !== 'Ingresos' && t.type !== 'INGRESO').reduce((sum, t) => sum + t.amount, 0)
                },
                transacciones: transactionData.map(t => ({
                    fecha: t.date.toISOString().split('T')[0],
                    descripcion: t.description,
                    monto: t.amount,
                    categoria: t.category,
                    tipo: t.type,
                    fuente: t.source || 'Desconocido'
                })),
                categorias: transactionData.reduce((acc, t) => {
                    if (t.category !== 'Ingresos' && t.type !== 'INGRESO') {
                        acc[t.category] = (acc[t.category] || 0) + t.amount;
                    }
                    return acc;
                }, {})
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `analisis-presupuesto-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Resultados exportados correctamente', 'success');
        }

        // Initialize animations when sections become visible
        function initAnimations() {
            setTimeout(() => {
                document.querySelectorAll('.initial-hidden').forEach((el, index) => {
                    setTimeout(() => {
                        el.classList.remove('initial-hidden');
                    }, index * 100);
                });
            }, 100);
        }

        // Call initialization
        initAnimations();

        // Debug helpers
        window.debugApp = {
            showTransactionData: () => console.table(transactionData),
            showCategories: () => console.log(categories),
            testNotification: (type) => showNotification(`Test ${type} notification`, type),
            resetApp: resetToUpload
        };

        console.log('üí∞ MoneyVault inicializado correctamente');
        console.log('Usa window.debugApp para funciones de depuraci√≥n');
        // ===================
// SISTEMA MODULAR DE PROCESADORES POR BANCO
// ===================

// Clase base para transacciones estandarizadas
class Transaction {
    constructor(description, amount, date, category = 'Otros', type = 'GASTO', source = 'Desconocido') {
        this.description = description.trim();
        this.amount = Math.abs(parseFloat(amount));
        this.date = new Date(date);
        this.category = category;
        this.type = type;
        this.source = source;
        this.id = `${source}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
    }
}

// ===================
// PROCESADOR BBVA
// ===================
class BBVAProcessor {
    static bankName = 'BBVA';
    
    static async processPDF(text) {
        console.log('üè¶ Procesando BBVA PDF...');
        const transactions = [];
        const lines = text.split('\n');

        for (let line of lines) {
            line = line.trim();
            if (line.length < 15) continue;

            // Patr√≥n BBVA: DD/MM/YYYY DESCRIPCION $MONTO
            const pattern = /(\d{1,2}\/\d{1,2}\/\d{4})\s+(.+?)\s+\$?([\d,]+\.?\d*)/;
            const match = line.match(pattern);

            if (match) {
                const [_, dateStr, description, amountStr] = match;
                const amount = parseFloat(amountStr.replace(/,/g, ''));

                if (!isNaN(amount) && amount > 0 && description.length > 3) {
                    const transaction = new Transaction(
                        description,
                        amount,
                        this.parseDate(dateStr),
                        this.categorize(description),
                        this.isIncome(description) ? 'INGRESO' : 'GASTO',
                        this.bankName
                    );
                    transactions.push(transaction);
                }
            }
        }

        console.log(`‚úÖ BBVA: ${transactions.length} transacciones encontradas`);
        return transactions;
    }

    static async processCSV(csvData) {
        console.log('üè¶ Procesando BBVA CSV...');
        const transactions = [];

        for (let row of csvData) {
            const fecha = row.fecha || row.date;
            const descripcion = row.descripcion || row.description || row.concepto;
            const cargo = parseFloat((row.cargo || '0').toString().replace(/[,$]/g, '')) || 0;
            const abono = parseFloat((row.abono || '0').toString().replace(/[,$]/g, '')) || 0;

            if (fecha && descripcion && (cargo > 0 || abono > 0)) {
                const amount = cargo || abono;
                const transaction = new Transaction(
                    descripcion,
                    amount,
                    fecha,
                    this.categorize(descripcion),
                    abono > 0 ? 'INGRESO' : 'GASTO',
                    this.bankName
                );
                transactions.push(transaction);
            }
        }

        console.log(`‚úÖ BBVA CSV: ${transactions.length} transacciones`);
        return transactions;
    }

    static parseDate(dateStr) {
        // DD/MM/YYYY
        const parts = dateStr.split('/');
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    static isIncome(description) {
        const desc = description.toLowerCase();
        return ['abono', 'deposito', 'nomina', 'transferencia recibida', 'devolucion']
            .some(keyword => desc.includes(keyword));
    }

    static categorize(description) {
        return categorizeTransaction(description);
    }
}

// ===================
// PROCESADOR SANTANDER
// ===================
class SantanderProcessor {
    static bankName = 'Santander';
    
    static async processPDF(text) {
        console.log('üî¥ Procesando Santander PDF...');
        const transactions = [];
        const lines = text.split('\n');

        for (let line of lines) {
            line = line.trim();
            if (line.length < 15) continue;

            // Patr√≥n Santander: DD-MMM-YYYY DESCRIPCION $MONTO
            const pattern = /(\d{2}-[A-Z]{3}-\d{4})\s+(.+?)\s+\$\s*([\d,]+\.?\d*)/;
            const match = line.match(pattern);

            if (match) {
                const [_, dateStr, description, amountStr] = match;
                const amount = parseFloat(amountStr.replace(/,/g, ''));

                if (!isNaN(amount) && amount > 0 && description.length > 3) {
                    const transaction = new Transaction(
                        description,
                        amount,
                        this.parseDate(dateStr),
                        this.categorize(description),
                        this.isIncome(description) ? 'INGRESO' : 'GASTO',
                        this.bankName
                    );
                    transactions.push(transaction);
                }
            }
        }

        console.log(`‚úÖ Santander: ${transactions.length} transacciones encontradas`);
        return transactions;
    }

    static parseDate(dateStr) {
        // DD-MMM-YYYY
        const monthMap = {
            'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
            'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
        };
        
        const parts = dateStr.split('-');
        const day = parseInt(parts[0]);
        const month = monthMap[parts[1]];
        const year = parseInt(parts[2]);
        
        return new Date(year, month, day);
    }

    static isIncome(description) {
        const desc = description.toLowerCase();
        return ['abono', 'deposito', 'transferencia recibida', 'devolucion', 'pago nomina']
            .some(keyword => desc.includes(keyword));
    }

    static categorize(description) {
        return categorizeTransaction(description);
    }
}

// ===================
// PROCESADOR NU BANK
// ===================
class NuProcessor {
    static bankName = 'Nu';
    
    static async processPDF(text) {
        console.log('üíú Procesando Nu PDF...');
        const transactions = [];
        const lines = text.split('\n');

        for (let line of lines) {
            line = line.trim();
            if (line.length < 10) continue;

            // Patr√≥n Nu: DD/MM DESCRIPCION $MONTO
            const pattern = /(\d{1,2}\/\d{1,2})\s+(.+?)\s+\$?([\d,]+\.?\d*)/;
            const match = line.match(pattern);

            if (match) {
                const [_, dateStr, description, amountStr] = match;
                const amount = parseFloat(amountStr.replace(/,/g, ''));

                if (!isNaN(amount) && amount > 0 && description.length > 3) {
                    const transaction = new Transaction(
                        description,
                        amount,
                        this.parseDate(dateStr),
                        this.categorize(description),
                        this.isIncome(description) ? 'INGRESO' : 'GASTO',
                        this.bankName
                    );
                    transactions.push(transaction);
                }
            }
        }

        console.log(`‚úÖ Nu: ${transactions.length} transacciones encontradas`);
        return transactions;
    }

    static parseDate(dateStr) {
        // DD/MM (a√±o actual)
        const [day, month] = dateStr.split('/');
        const currentYear = new Date().getFullYear();
        return new Date(currentYear, parseInt(month) - 1, parseInt(day));
    }

    static isIncome(description) {
        const desc = description.toLowerCase();
        return ['pix recebido', 'transferencia', 'rendimento', 'cashback', 'reembolso']
            .some(keyword => desc.includes(keyword));
    }

    static categorize(description) {
        return categorizeTransaction(description);
    }
}

// ===================
// PROCESADOR BANORTE
// ===================
class BanorteProcessor {
    static bankName = 'Banorte';
    
    static async processPDF(text) {
        console.log('üü† Procesando Banorte PDF...');
        const transactions = [];
        const lines = text.split('\n');

        for (let line of lines) {
            line = line.trim();
            if (line.length < 15) continue;

            // Patr√≥n Banorte: DD/MM/YYYY DESCRIPCION $MONTO
            const pattern = /(\d{1,2}\/\d{1,2}\/\d{4})\s+(.+?)\s+\$?([\d,]+\.?\d*)/;
            const match = line.match(pattern);

            if (match) {
                const [_, dateStr, description, amountStr] = match;
                const amount = parseFloat(amountStr.replace(/,/g, ''));

                if (!isNaN(amount) && amount > 0 && description.length > 3) {
                    const transaction = new Transaction(
                        description,
                        amount,
                        BBVAProcessor.parseDate(dateStr), // Mismo formato que BBVA
                        this.categorize(description),
                        this.isIncome(description) ? 'INGRESO' : 'GASTO',
                        this.bankName
                    );
                    transactions.push(transaction);
                }
            }
        }

        console.log(`‚úÖ Banorte: ${transactions.length} transacciones encontradas`);
        return transactions;
    }

    static isIncome(description) {
        const desc = description.toLowerCase();
        return ['abono', 'deposito', 'nomina', 'transferencia recibida']
            .some(keyword => desc.includes(keyword));
    }

    static categorize(description) {
        return categorizeTransaction(description);
    }
}

// ===================
// DETECTOR DE BANCO
// ===================
class BankDetector {
    static detect(text, fileName = '') {
        const content = (text + ' ' + fileName).toLowerCase();
        
        if (content.includes('bbva')) return BBVAProcessor;
        if (content.includes('santander')) return SantanderProcessor;
        if (content.includes('nu m√©xico') || content.includes('cuenta nu') || fileName.toLowerCase().includes('nu')) return NuProcessor;
        if (content.includes('banorte')) return BanorteProcessor;
        
        console.log('‚ö†Ô∏è Banco no detectado, usando procesador gen√©rico');
        return null;
    }
}

// ===================
// CONSOLIDADOR PRINCIPAL
// ===================
class BankConsolidator {
    constructor() {
        this.allTransactions = [];
        this.bankStats = {};
        this.processedFiles = [];
    }

    async processFile(file) {
        console.log(`üìÑ Procesando: ${file.name}`);
        
        try {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            let transactions = [];
            let bankName = 'Gen√©rico';

            if (fileExtension === 'pdf') {
                const text = await this.extractPDFText(file);
                const processor = BankDetector.detect(text, file.name);
                
                if (processor) {
                    transactions = await processor.processPDF(text);
                    bankName = processor.bankName;
                } else {
                    transactions = await this.processGenericPDF(text);
                }

            } else if (fileExtension === 'csv') {
                const csvData = await this.parseCSV(file);
                const processor = BankDetector.detect('', file.name);
                
                if (processor && processor.processCSV) {
                    transactions = await processor.processCSV(csvData);
                    bankName = processor.bankName;
                } else {
                    transactions = await this.processGenericCSV(csvData);
                }

            } else if (['xlsx', 'xls'].includes(fileExtension)) {
                const excelData = await this.parseExcel(file);
                const processor = BankDetector.detect('', file.name);
                
                if (processor && processor.processCSV) {
                    transactions = await processor.processCSV(excelData);
                    bankName = processor.bankName;
                } else {
                    transactions = await this.processGenericCSV(excelData);
                }
            }

            // Agregar al consolidado
            this.addTransactions(transactions, bankName, file.name);

            return {
                success: true,
                transactions,
                bankName,
                count: transactions.length
            };

        } catch (error) {
            console.error(`‚ùå Error procesando ${file.name}:`, error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    addTransactions(transactions, bankName, fileName) {
        this.allTransactions.push(...transactions);
        
        if (!this.bankStats[bankName]) {
            this.bankStats[bankName] = {
                count: 0,
                files: [],
                totalAmount: 0
            };
        }
        
        this.bankStats[bankName].count += transactions.length;
        this.bankStats[bankName].files.push(fileName);
        this.bankStats[bankName].totalAmount += transactions.reduce((sum, t) => sum + t.amount, 0);
        
        this.processedFiles.push({
            name: fileName,
            bank: bankName,
            count: transactions.length,
            date: new Date()
        });
    }

    getConsolidatedReport() {
        const ingresos = this.allTransactions.filter(t => t.type === 'INGRESO');
        const gastos = this.allTransactions.filter(t => t.type === 'GASTO');
        
        const totalIngresos = ingresos.reduce((sum, t) => sum + t.amount, 0);
        const totalGastos = gastos.reduce((sum, t) => sum + t.amount, 0);
        
        // Agrupar por categor√≠as
        const categoryTotals = {};
        gastos.forEach(t => {
            categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
        });

        return {
            summary: {
                totalTransactions: this.allTransactions.length,
                totalIngresos,
                totalGastos,
                ahorroReal: totalIngresos - totalGastos,
                porcentajeAhorro: totalIngresos > 0 ? ((totalIngresos - totalGastos) / totalIngresos * 100) : 0,
                banksProcessed: Object.keys(this.bankStats).length,
                filesProcessed: this.processedFiles.length
            },
            categoryTotals,
            bankStats: this.bankStats,
            processedFiles: this.processedFiles,
            allTransactions: this.allTransactions
        };
    }

    // M√©todos auxiliares
    async extractPDFText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }
        
        return fullText;
    }

    async parseCSV(file) {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) return [];
        
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = this.parseCSVLine(lines[i]);
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index]?.replace(/"/g, '') || '';
            });
            data.push(row);
        }
        
        return data;
    }

    parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }

    async parseExcel(file) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length < 2) return [];
        
        const headers = jsonData[0].map(h => String(h || '').trim().toLowerCase());
        const data_rows = [];
        
        for (let i = 1; i < jsonData.length; i++) {
            if (jsonData[i] && jsonData[i].length > 0) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = jsonData[i][index] || '';
                });
                data_rows.push(row);
            }
        }
        
        return data_rows;
    }

    async processGenericPDF(text) {
        console.log('üîß Usando procesador gen√©rico para PDF...');
        const transactions = [];
        const lines = text.split('\n');
        
        for (let line of lines) {
            line = line.trim();
            if (line.length < 10) continue;
            
            // Intentar varios patrones de fecha
            const datePatterns = [
                /(\d{1,2}\/\d{1,2}\/\d{4})/,
                /(\d{1,2}-\d{1,2}-\d{4})/,
                /(\d{1,2} [A-Z]{3} \d{4})/
            ];
            
            let dateFound = null;
            for (const pattern of datePatterns) {
                const match = line.match(pattern);
                if (match) {
                    dateFound = match[1];
                    break;
                }
            }
            
            if (dateFound && line.includes('$')) {
                const amountMatch = line.match(/\$?([\d,]+\.?\d*)/);
                
                if (amountMatch) {
                    const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
                    if (!isNaN(amount) && amount > 0) {
                        const description = line
                            .replace(dateFound, '')
                            .replace(amountMatch[0], '')
                            .trim();
                        
                        if (description.length > 5) {
                            const transaction = new Transaction(
                                description,
                                amount,
                                new Date(dateFound),
                                categorizeTransaction(description),
                                this.isGenericIncome(description) ? 'INGRESO' : 'GASTO',
                                'Gen√©rico'
                            );
                            transactions.push(transaction);
                        }
                    }
                }
            }
        }
        
        console.log(`‚úÖ Gen√©rico: ${transactions.length} transacciones`);
        return transactions;
    }

    async processGenericCSV(csvData) {
        console.log('üîß Usando procesador gen√©rico para CSV...');
        const transactions = [];
        
        if (csvData.length === 0) return transactions;
        
        const firstRow = csvData[0];
        const headers = Object.keys(firstRow);
        
        // Buscar columnas comunes
        const descField = headers.find(h => 
            ['descripcion', 'concepto', 'description', 'merchant', 'comercio'].some(field => 
                h.toLowerCase().includes(field)
            )
        );
        
        const amountField = headers.find(h => 
            ['monto', 'importe', 'amount', 'cantidad', 'cargo', 'abono'].some(field => 
                h.toLowerCase().includes(field)
            )
        );
        
        const dateField = headers.find(h => 
            ['fecha', 'date', 'dia'].some(field => 
                h.toLowerCase().includes(field)
            )
        );
        
        if (descField && amountField && dateField) {
            for (let row of csvData) {
                const amount = parseFloat(String(row[amountField] || '0').replace(/[,$]/g, ''));
                if (amount > 0) {
                    const transaction = new Transaction(
                        row[descField] || 'Sin descripci√≥n',
                        amount,
                        row[dateField],
                        categorizeTransaction(row[descField] || ''),
                        this.isGenericIncome(row[descField] || '') ? 'INGRESO' : 'GASTO',
                        'Gen√©rico'
                    );
                    transactions.push(transaction);
                }
            }
        }
        
        console.log(`‚úÖ Gen√©rico CSV: ${transactions.length} transacciones`);
        return transactions;
    }

    isGenericIncome(description) {
        const desc = description.toLowerCase();
        return ['abono', 'deposito', 'transferencia recibida', 'nomina', 'salario', 'intereses']
            .some(keyword => desc.includes(keyword));
    }

    reset() {
        this.allTransactions = [];
        this.bankStats = {};
        this.processedFiles = [];
    }
}

// Funci√≥n de categorizaci√≥n global (reutiliza tu l√≥gica existente)
function categorizeTransaction(description) {
    const desc = description.toLowerCase();
    
    const categories = {
        'Alimentaci√≥n': ['supermercado', 'mercado', 'abarrotes', 'walmart', 'soriana', 'oxxo', 'seven'],
        'Restaurantes': ['restaurante', 'comida', 'food', 'burger', 'pizza', 'starbucks', 'mc', 'kfc'],
        'Transporte': ['gasolina', 'uber', 'taxi', 'metro', 'pemex', 'parking', 'didi'],
        'Entretenimiento': ['cine', 'netflix', 'spotify', 'gym', 'deporte', 'juego'],
        'Servicios': ['luz', 'agua', 'telefono', 'internet', 'cfe', 'telmex', 'izzi'],
        'Salud': ['farmacia', 'hospital', 'doctor', 'medicina', 'dental'],
        'Compras': ['amazon', 'liverpool', 'palacio', 'tienda', 'mercadolibre'],
        'Efectivo': ['atm', 'cajero', 'retiro', 'efectivo', 'cash'],
        'Transferencias': ['spei', 'transferencia', 'pago cuenta']
    };
    
    for (const [category, keywords] of Object.entries(categories)) {
        if (keywords.some(keyword => desc.includes(keyword))) {
            return category;
        }
    }
    
    return 'Otros';
}

// Exportar para uso global
window.BankConsolidator = BankConsolidator;
window.Transaction = Transaction;

console.log('üèóÔ∏è Sistema modular de bancos cargado correctamente');
    </script>
</body>
</html>
