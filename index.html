<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Presupuesto Personal</title>
    
    <!-- CDN Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===================
           HEADER STYLES
        =================== */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* ===================
           UPLOAD SECTION STYLES
        =================== */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8f0ff);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #f0f4ff, #dde7ff);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e6f3ff, #cce7ff);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a5568;
            font-weight: 600;
        }

        .upload-hint {
            color: #718096;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        /* ===================
           BUTTON STYLES
        =================== */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .process-all-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-all-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .process-all-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ===================
           RESULTS SECTION STYLES
        =================== */
        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===================
           CHARTS STYLES
        =================== */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            height: 400px;
        }

        .chart-card canvas {
            max-height: 300px !important;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        /* ===================
           BUDGET SECTION STYLES
        =================== */
        .budget-section {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .budget-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .budget-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .budget-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: #2d3748;
        }

        .budget-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        /* ===================
           LOADING AND ERROR STYLES
        =================== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        /* ===================
           FILES QUEUE STYLES
        =================== */
        .files-queue-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .files-queue {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .queue-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-weight: bold;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
        }

        .file-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 15px;
            align-items: center;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Status badges */
        .status-pending { 
            background: #fef5e7; 
            color: #dd6b20; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            text-align: center; 
            font-weight: 600;
        }
        
        .status-processing { 
            background: #ebf8ff; 
            color: #3182ce; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            text-align: center; 
            font-weight: 600;
        }
        
        .status-completed { 
            background: #e6fffa; 
            color: #38b2ac; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            text-align: center; 
            font-weight: 600;
        }
        
        .status-error { 
            background: #fed7d7; 
            color: #e53e3e; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            text-align: center; 
            font-weight: 600;
        }

        /* ===================
           MANUAL EXPENSES STYLES
        =================== */
        .manual-expenses-flow {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .expense-form {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 0.3fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .add-expense-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-expense-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        /* ===================
           NOTIFICATION STYLES
        =================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.success {
            background: #48bb78;
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .notification.error {
            background: #e53e3e;
            box-shadow: 0 10px 25px rgba(229, 62, 62, 0.3);
        }

        .notification.warning {
            background: #dd6b20;
            box-shadow: 0 10px 25px rgba(221, 107, 32, 0.3);
        }

        /* ===================
           RESPONSIVE DESIGN
        =================== */
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .queue-header, .file-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .upload-area {
                padding: 40px 15px;
            }

            .upload-icon {
                font-size: 3rem;
            }

            .upload-text {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .upload-section, .files-queue-section, .manual-expenses-flow, .results-section {
                padding: 20px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===================
             HEADER SECTION
        =================== -->
        <div class="header">
            <h1>üí∞ Analizador de Presupuesto Personal</h1>
            <p>Herramienta gratuita para analizar tus finanzas personales</p>
            <p style="font-size: 1rem; margin-top: 10px; opacity: 0.8;">
                Sube tu estado de cuenta y obt√©n un an√°lisis completo de tus gastos con recomendaciones personalizadas
            </p>
        </div>

        <!-- ===================
             PASO 1: SUBIR M√öLTIPLES ARCHIVOS
        =================== -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Arrastra todos tus estados de cuenta aqu√≠</div>
                <div class="upload-hint">Soporta archivos de BBVA, Santander, Banorte, Nu y otros bancos mexicanos</div>
                <div class="upload-hint" style="margin-bottom: 20px; font-weight: 600; color: #667eea;">
                    ‚ú® Nuevo: Sube m√∫ltiples archivos de diferentes bancos de una vez
                </div>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ Seleccionar Estados de Cuenta
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv,.pdf" multiple>
            </div>
        </div>

        <!-- ===================
             COLA DE ARCHIVOS
        =================== -->
        <div class="files-queue-section" id="filesQueueSection" style="display: none;">
            <div style="text-align: center; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìã Archivos Listos para Procesar</h3>
                <p style="color: #4a5568;">Revisa tus archivos y procesa cuando est√©s listo</p>
            </div>
            
            <div class="files-queue">
                <div class="queue-header">
                    <div>Archivo</div>
                    <div>Banco</div>
                    <div>Tama√±o</div>
                    <div>Estado</div>
                    <div>Acci√≥n</div>
                </div>
                <div id="filesQueueList">
                    <!-- Archivos se agregan din√°micamente aqu√≠ -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button id="processAllFilesBtn" class="process-all-btn" disabled onclick="startProcessingFlow()">
                    ‚ö° Procesar Todos los Archivos
                </button>
                <button onclick="addMoreFiles()" style="background: #718096; color: white; padding: 12px 25px; border: none; border-radius: 25px; margin-left: 15px; cursor: pointer;">
                    ‚ûï Agregar M√°s Archivos
                </button>
            </div>
        </div>

        <!-- ===================
             PASO 2: GASTOS MANUALES
        =================== -->
        <div class="manual-expenses-flow" id="manualExpensesFlow" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">üíµ Paso 2: Gastos en Efectivo</h3>
                <p style="color: #4a5568;">Agrega gastos que no aparecen en tus estados de cuenta</p>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>Estados procesados:</strong> <span id="processedBanksInfo">0 archivos</span> | 
                    <strong>Transacciones encontradas:</strong> <span id="processedTransactionsInfo">0</span>
                </div>
            </div>

            <!-- Formulario simplificado para m√∫ltiples gastos -->
            <div class="expense-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="quickExpenseDescription">Descripci√≥n</label>
                        <input type="text" id="quickExpenseDescription" class="form-input" 
                               placeholder="Ej: Comida en puesto" required>
                    </div>
                    <div class="form-group">
                        <label for="quickExpenseAmount">Monto ($)</label>
                        <input type="number" id="quickExpenseAmount" class="form-input" 
                               placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="quickExpenseCategory">Categor√≠a</label>
                        <select id="quickExpenseCategory" class="form-select" required>
                            <option value="">Seleccionar</option>
                            <option value="Alimentaci√≥n">üõí Alimentaci√≥n</option>
                            <option value="Restaurantes">üçï Restaurantes</option>
                            <option value="Transporte">üöó Transporte</option>
                            <option value="Entretenimiento">üé¨ Entretenimiento</option>
                            <option value="Salud">üè• Salud</option>
                            <option value="Compras">üõçÔ∏è Compras</option>
                            <option value="Servicios">‚ö° Servicios</option>
                            <option value="Otros">‚ùì Otros</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button type="button" onclick="addQuickExpense()" class="add-expense-btn">
                            ‚ûï Agregar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista r√°pida de gastos agregados -->
            <div id="quickExpensesList" style="background: white; border-radius: 10px; padding: 20px; margin: 20px 0; max-height: 200px; overflow-y: auto;">
                <div style="text-align: center; color: #718096;">
                    No hay gastos en efectivo agregados
                </div>
            </div>

            <!-- Botones de navegaci√≥n -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="skipManualExpenses()" style="background: #718096; color: white; padding: 15px 30px; border: none; border-radius: 25px; margin-right: 15px; cursor: pointer;">
                    ‚è≠Ô∏è Omitir Gastos en Efectivo
                </button>
                <button onclick="proceedToConsolidated()" class="process-all-btn">
                    üìä Ver An√°lisis Consolidado
                </button>
            </div>
        </div>

        <!-- ===================
             LOADING SECTION
        =================== -->
        <div id="loadingSection" class="loading" style="display: none;">
            <div>‚è≥ Procesando tu archivo...</div>
            <div style="margin-top: 15px; font-size: 1rem; opacity: 0.8;">
                Esto puede tomar unos segundos...
            </div>
        </div>

        <!-- ===================
             ERROR SECTION
        =================== -->
        <div id="errorSection" class="error" style="display: none;">
            <!-- Mensaje de error se inserta din√°micamente -->
        </div>

        <!-- ===================
             PENDING SECTION (Para archivos no procesados)
        =================== -->
        <div id="pendingSection" class="results-section" style="display: none;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <h2 style="color: #667eea; margin-bottom: 20px;">Archivo en proceso</h2>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    No pudimos procesar este estado de cuenta autom√°ticamente, pero estamos trabajando para soportar todos los bancos mexicanos.
                </p>
                <p style="font-size: 1.1rem; line-height: 1.6; color: #4a5568; margin-bottom: 30px;">
                    D√©janos tu email y el nombre de tu banco, te notificaremos en 24-48h cuando tu reporte est√© listo.
                </p>
                <p style="font-size: 1rem; color: #718096; margin-bottom: 40px;">
                    <strong>¬°No necesitas volver a subir nada!</strong>
                </p>
            </div>

            <!-- Formulario HubSpot -->
            <div style="max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                <script src="https://js.hsforms.net/forms/embed/50122034.js" defer></script>
                <div class="hs-form-frame" data-region="na1" data-form-id="7ba42206-42b9-4c9f-8d78-209b9166b526" data-portal-id="50122034"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" id="tryAnotherFile" 
                            style="background: none; border: none; color: #667eea; text-decoration: underline; cursor: pointer; font-size: 1rem;"
                            onclick="resetToUpload()">
                        Probar con otro archivo
                    </button>
                </div>
            </div>
        </div>

        <!-- ===================
             RESULTS SECTION (An√°lisis principal)
        =================== -->
        <div id="resultsSection" class="results-section">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalIngresos">$0</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalExpenses">$0</div>
                    <div class="stat-label">Gastos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ahorroReal">$0</div>
                    <div class="stat-label">Ahorro Real</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="porcentajeAhorro">0%</div>
                    <div class="stat-label">% de Ahorro</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transacciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">Categor√≠a Principal</div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">Gastos por Categor√≠a</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Tendencia Mensual</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Budget Suggestions -->
            <div class="budget-section">
                <div class="budget-title">üéØ Presupuesto Sugerido (Mensual)</div>
                <p style="text-align: center; margin-bottom: 20px; color: #4a5568;">
                    Basado en tu historial de gastos, con un objetivo de optimizaci√≥n del 10%
                </p>
                <div class="budget-categories" id="budgetCategories">
                    <!-- Presupuesto se genera din√°micamente -->
                </div>
            </div>

            <!-- Tips Section -->
            <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px;">
                <p style="color: #718096; font-size: 0.9rem;">
                    üí° <strong>Tip:</strong> Esta herramienta analiza tus patrones de gasto hist√≥ricos. 
                    Para mejores resultados, usa datos de al menos 3 meses.
                </p>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="resetToUpload()" class="btn" style="margin-right: 15px;">
                    üîÑ Analizar Otro Archivo
                </button>
                <button onclick="exportResults()" class="btn" style="background: linear-gradient(135deg, #48bb78, #38a169);">
                    üìä Exportar Resultados
                </button>
            </div>
        </div>
    </div>

    <!-- ===================
         MODAL DE APRENDIZAJE (Oculto por defecto)
    =================== -->
    <div id="learningModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">üß† Ayuda al sistema a aprender</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #4a5568;">
                Encontramos algunas transacciones que no pudimos categorizar autom√°ticamente. 
                ¬øPuedes ayudarnos a mejorar?
            </p>
            
            <div id="learningTransactions">
                <!-- Transacciones para aprender se insertan din√°micamente -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="finishLearning" class="btn">Continuar con el an√°lisis</button>
            </div>
        </div>
    </div>
</body>
</html>
<script>
// ===================
// VARIABLES GLOBALES
// ===================
let transactionData = [];
let categoryChart = null;
let trendChart = null;
let pendingFileData = null;

// Variables para el flujo mejorado
let currentStep = 1; // 1: Archivos, 2: Gastos manuales, 3: Consolidado
let processedFilesData = [];
let quickManualExpenses = [];
let allConsolidatedTransactions = [];
let fileQueue = [];
let nextFileId = 1;

// Sistema de aprendizaje
let learnedPatterns = {};
let pendingToLearn = {};
let uncategorizedTransactions = [];

// ===================
// CATEGOR√çAS PARA AN√ÅLISIS
// ===================
const categories = {
    'Ingresos': [
        'spei recibido', 'deposito', 'dep√≥sito', 'transferencia recibida', 
        'pago de nomina', 'n√≥mina', 'salario', 'sueldo', 'abono', 'intereses', 
        'rendimiento', 'venta fondos', 'devolucion', 'devoluci√≥n', 'reembolso', 
        'cashback', 'deposito de inversion', 'liquidacion'
    ],
    'Alimentaci√≥n': [
        'supermercado', 'mercado', 'abarrotes', 'tienda', 'grocery', 'market', 
        'soriana', 'walmart', 'chedraui', 'oxxo', 'seven', '7-eleven', 
        'farmacia guadalajara', 'benavides', 'del rio', 'bodega aurrera', 
        'comercial mexicana', 'coppel'
    ],
    'Restaurantes': [
        'restaurante', 'restaurant', 'comida', 'food', 'burger', 'pizza', 'taco', 
        'caf√©', 'coffee', 'bar', 'cantina', 'mc', 'kfc', 'subway', 'dominos', 
        'uber eats', 'rappi', 'didi food', 'sin delantal', 'starbucks', 'vips', 
        'sanborns', 'applebees', 'chilis'
    ],
    'Transporte': [
        'gasolina', 'gas', 'uber', 'taxi', 'metro', 'autobus', 'bus', 'parking', 
        'estacionamiento', 'pemex', 'shell', 'bp', 'mobil', 'didi', 'beat', 
        'caseta', 'autopista', 'peaje'
    ],
    'Entretenimiento': [
        'cine', 'cinema', 'netflix', 'spotify', 'juego', 'game', 'teatro', 
        'concierto', 'club', 'gym', 'deporte', 'cinepolis', 'cinemex', 
        'smart fit', 'sports world', 'disney', 'amazon prime', 'hbo'
    ],
    'Servicios': [
        'luz', 'agua', 'gas', 'telefono', 'internet', 'cable', 'netflix', 
        'spotify', 'servicio', 'cfe', 'telmex', 'telcel', 'att', 'movistar', 
        'unefon', 'izzi', 'sky', 'dish', 'megacable'
    ],
    'Salud': [
        'farmacia', 'hospital', 'doctor', 'medicina', 'dental', 'laboratorio', 
        'clinica', 'seguro', 'similares', 'guadalajara', 'benavides', 'del rio', 
        'issste', 'imss', 'medica sur', 'angeles'
    ],
    'Compras': [
        'amazon', 'mercadolibre', 'liverpool', 'palacio', 'sears', 'tienda', 
        'ropa', 'zapatos', 'electronico', 'elektra', 'coppel', 'famsa', 
        'office depot', 'best buy', 'radioshack'
    ],
    'Efectivo': [
        'atm', 'cajero', 'retiro', 'efectivo', 'cash', 'disposicion', 
        'retiro en cajero'
    ],
    'Transferencias': [
        'spei enviado', 'transferencia', 'pago cuenta tercero', 'pago a tercero', 
        'envio', 'transferencia enviada'
    ],
    'Otros': []
};

// ===================
// INICIALIZACI√ìN
// ===================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Analizador de Presupuesto Personal - Inicializando...');
    initImprovedFlow();
    setupEventListeners();
});

function initImprovedFlow() {
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');

    if (!fileInput || !uploadArea) {
        console.error('‚ùå Elementos de upload no encontrados');
        return;
    }

    // Event listeners para drag & drop
    uploadArea.addEventListener('dragover', handleDragOverImproved);
    uploadArea.addEventListener('dragleave', handleDragLeaveImproved);
    uploadArea.addEventListener('drop', handleDropImproved);
    uploadArea.addEventListener('click', () => fileInput.click());

    // Event listener para selecci√≥n de archivos
    fileInput.addEventListener('change', handleFileSelectionImproved);

    console.log('‚úÖ Flujo de archivos inicializado');
}

function setupEventListeners() {
    // Bot√≥n "Probar otro archivo"
    const tryAnotherBtn = document.getElementById('tryAnotherFile');
    if (tryAnotherBtn) {
        tryAnotherBtn.addEventListener('click', resetToUpload);
    }

    // Enter key para agregar gastos
    const amountInput = document.getElementById('quickExpenseAmount');
    if (amountInput) {
        amountInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addQuickExpense();
            }
        });
    }

    console.log('‚úÖ Event listeners configurados');
}

// ===================
// FUNCIONES DE DRAG & DROP MEJORADAS
// ===================
function handleDragOverImproved(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.add('dragover');
}

function handleDragLeaveImproved(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
}

function handleDropImproved(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    addFilesToImprovedQueue(files);
}

function handleFileSelectionImproved(e) {
    const files = Array.from(e.target.files);
    addFilesToImprovedQueue(files);
}

// ===================
// GESTI√ìN DE ARCHIVOS
// ===================
function addFilesToImprovedQueue(files) {
    const validExtensions = ['pdf', 'xlsx', 'xls', 'csv'];
    let validFilesAdded = 0;

    files.forEach(file => {
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (validExtensions.includes(extension)) {
            const fileItem = {
                id: nextFileId++,
                file: file,
                name: file.name,
                size: formatFileSize(file.size),
                status: 'pending',
                progress: 0,
                bank: detectBank(file.name),
                transactions: []
            };
            
            fileQueue.push(fileItem);
            validFilesAdded++;
        } else {
            showNotification(`Archivo ${file.name} no v√°lido. Solo PDF, Excel y CSV.`, 'error');
        }
    });

    if (validFilesAdded > 0) {
        updateImprovedFilesDisplay();
        showFilesQueueSection();
        showNotification(`${validFilesAdded} archivo${validFilesAdded > 1 ? 's' : ''} agregado${validFilesAdded > 1 ? 's' : ''} a la cola`, 'success');
    }
}

function detectBank(fileName) {
    const name = fileName.toLowerCase();
    
    if (name.includes('bbva')) return { name: 'BBVA', logo: 'üè¶' };
    if (name.includes('santander')) return { name: 'Santander', logo: 'üî¥' };
    if (name.includes('banorte')) return { name: 'Banorte', logo: 'üü†' };
    if (name.includes('nu')) return { name: 'Nu', logo: 'üíú' };
    if (name.includes('hsbc')) return { name: 'HSBC', logo: '‚ö™' };
    if (name.includes('banamex')) return { name: 'Banamex', logo: 'üîµ' };
    
    return { name: 'Otro Banco', logo: 'üèõÔ∏è' };
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const icons = { 
        'pdf': 'üìÑ', 
        'xlsx': 'üìä', 
        'xls': 'üìä', 
        'csv': 'üìã' 
    };
    return icons[ext] || 'üìÑ';
}

function getStatusText(status) {
    const texts = {
        'pending': 'Pendiente',
        'processing': 'Procesando',
        'completed': 'Completado',
        'error': 'Error'
    };
    return texts[status] || 'Desconocido';
}

// ===================
// INTERFAZ DE USUARIO
// ===================
function showFilesQueueSection() {
    const section = document.getElementById('filesQueueSection');
    if (section) {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    }
}

function updateImprovedFilesDisplay() {
    const queueList = document.getElementById('filesQueueList');
    const processBtn = document.getElementById('processAllFilesBtn');

    if (!queueList || !processBtn) {
        console.error('‚ùå Elementos de cola no encontrados');
        return;
    }

    if (fileQueue.length === 0) {
        document.getElementById('filesQueueSection').style.display = 'none';
        return;
    }

    queueList.innerHTML = fileQueue.map(file => `
        <div class="file-item">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.2rem;">${getFileIcon(file.name)}</span>
                <div>
                    <div style="font-weight: 600;">${file.name.length > 25 ? file.name.substring(0, 25) + '...' : file.name}</div>
                    <div style="font-size: 0.8rem; color: #718096;">${file.name}</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${file.bank.logo}</span>
                <span style="font-weight: 600;">${file.bank.name}</span>
            </div>
            <div style="color: #4a5568;">${file.size}</div>
            <div class="status-${file.status}">
                ${getStatusText(file.status)}
            </div>
            <button onclick="removeFileFromImprovedQueue(${file.id})" 
                    style="background: #fed7d7; color: #e53e3e; border: none; padding: 8px 12px; border-radius: 50%; cursor: pointer; font-weight: bold;"
                    title="Eliminar archivo">√ó</button>
        </div>
    `).join('');

    // Actualizar bot√≥n de procesar
    const pendingFiles = fileQueue.filter(f => f.status === 'pending').length;
    processBtn.disabled = pendingFiles === 0;
    processBtn.textContent = pendingFiles > 0 ? 
        `‚ö° Procesar ${pendingFiles} Archivo${pendingFiles > 1 ? 's' : ''}` : 
        '‚ö° Sin archivos pendientes';
}

function removeFileFromImprovedQueue(fileId) {
    fileQueue = fileQueue.filter(file => file.id !== fileId);
    updateImprovedFilesDisplay();
    
    if (fileQueue.length === 0) {
        document.getElementById('filesQueueSection').style.display = 'none';
    }
    
    showNotification('Archivo eliminado de la cola', 'success');
}

function addMoreFiles() {
    document.getElementById('fileInput').click();
}

// ===================
// NOTIFICACIONES
// ===================
function showNotification(message, type = 'success') {
    // Crear elemento de notificaci√≥n
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ===================
// ESTADOS DE LA APLICACI√ìN
// ===================
function showLoading() {
    hideAllSections();
    document.getElementById('loadingSection').style.display = 'block';
}

function showError(message) {
    hideAllSections();
    const errorSection = document.getElementById('errorSection');
    errorSection.innerHTML = `<strong>Error:</strong> ${message}`;
    errorSection.style.display = 'block';
}

function showPending() {
    hideAllSections();
    document.getElementById('pendingSection').style.display = 'block';
}

function showResults() {
    hideAllSections();
    document.getElementById('resultsSection').style.display = 'block';
}

function hideAllSections() {
    const sections = [
        'loadingSection', 'errorSection', 'pendingSection', 
        'resultsSection', 'uploadSection', 'filesQueueSection', 
        'manualExpensesFlow'
    ];
    
    sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'none';
        }
    });
}

function resetToUpload() {
    // Limpiar datos
    transactionData.length = 0;
    fileQueue.length = 0;
    processedFilesData.length = 0;
    quickManualExpenses.length = 0;
    allConsolidatedTransactions.length = 0;
    nextFileId = 1;
    currentStep = 1;
    
    // Destruir gr√°ficos existentes
    if (categoryChart) {
        categoryChart.destroy();
        categoryChart = null;
    }
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }
    
    // Mostrar secci√≥n de upload
    hideAllSections();
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
    
    // Limpiar input
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.value = '';
    }
    
    showNotification('Listo para analizar nuevos archivos', 'success');
}

// ===================
// UTILIDADES
// ===================
function generateFileId() {
    return 'file_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
}

// ===================
// FUNCIONES DE NAVEGACI√ìN
// ===================
function addMoreFiles() {
    document.getElementById('fileInput').click();
}

function skipManualExpenses() {
    proceedToConsolidated();
}

// Logging para debug
function logDebug(message, data = null) {
    console.log(`üîç [DEBUG] ${message}`, data || '');
}

function logError(message, error = null) {
    console.error(`‚ùå [ERROR] ${message}`, error || '');
}

logDebug('JavaScript Core cargado correctamente');
</script>
// ===================
// ===================
// PROCESADORES DE ARCHIVOS
// ===================

// Funci√≥n principal para procesar archivos
async function processFile(file) {
    showLoading();
    logDebug('Procesando archivo', file.name);
    
    try {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'csv') {
            await processCSV(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            await processExcel(file);
        } else if (fileExtension === 'pdf') {
            await processPDF(file);
        } else {
            throw new Error('Formato de archivo no soportado. Por favor usa CSV, Excel o PDF.');
        }
        
        if (transactionData.length === 0) {
            // No se pudieron procesar transacciones, enviar a HubSpot
            pendingFileData = {
                file: file,
                fileName: file.name,
                timestamp: new Date().toISOString(),
                fileId: generateFileId()
            };
            
            showPending();
            return;
        }
        
        // Limpiar datos de aprendizaje de sesiones anteriores
        uncategorizedTransactions = [];
        
        analyzeData();
        showResults();
        showNotification(`Archivo procesado: ${transactionData.length} transacciones encontradas`, 'success');
        
    } catch (error) {
        logError('Error procesando archivo', error);
        
        pendingFileData = {
            file: file,
            fileName: file.name,
            timestamp: new Date().toISOString(),
            fileId: generateFileId(),
            error: error.message
        };
        
        showPending();
    }
}

// ===================
// PROCESADOR CSV
// ===================
async function processCSV(file) {
    logDebug('Procesando archivo CSV');
    
    const text = await file.text();
    const lines = text.split('\n');
    
    if (lines.length < 2) {
        throw new Error('El archivo CSV debe tener al menos una l√≠nea de encabezado y una de datos.');
    }
    
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    transactionData = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            const values = lines[i].split(',');
            const transaction = parseTransaction(headers, values);
            if (transaction) {
                transactionData.push(transaction);
            }
        }
    }
    
    logDebug(`CSV procesado: ${transactionData.length} transacciones`);
}

// ===================
// PROCESADOR EXCEL
// ===================
async function processExcel(file) {
    logDebug('Procesando archivo Excel');
    
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    
    if (jsonData.length < 2) {
        throw new Error('El archivo Excel debe tener al menos una l√≠nea de encabezado y una de datos.');
    }
    
    const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
    transactionData = [];
    
    for (let i = 1; i < jsonData.length; i++) {
        if (jsonData[i].length > 0) {
            const transaction = parseTransaction(headers, jsonData[i]);
            if (transaction) {
                transactionData.push(transaction);
            }
        }
    }
    
    logDebug(`Excel procesado: ${transactionData.length} transacciones`);
}

// ===================
// PROCESADOR PDF PRINCIPAL
// ===================
async function processPDF(file) {
    logDebug('Procesando archivo PDF');
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }
        
        logDebug('Texto extra√≠do del PDF', fullText.substring(0, 200) + '...');
        
        // Detectar banco y usar procesador espec√≠fico
        if (fullText.includes('BBVA') || fullText.includes('bbva')) {
            await processBBVAPDF(fullText);
        } else if (fullText.includes('Santander') || fullText.includes('SANTANDER')) {
            await processSantanderPDF(fullText);
        } else if (fullText.includes('Nu M√©xico') || fullText.includes('Cuenta Nu')) {
            await processNuPDF(fullText);
        } else if (fullText.includes('Banorte') || fullText.includes('BANORTE')) {
            await processBanortePDF(fullText);
        } else {
            await processGenericPDF(fullText);
        }
        
        logDebug(`PDF procesado: ${transactionData.length} transacciones`);
        
    } catch (error) {
        logError('Error procesando PDF', error);
        throw new Error('Error al procesar el PDF. Aseg√∫rate de que sea un estado de cuenta v√°lido.');
    }
}

// ===================
// PROCESADOR BBVA MEJORADO
// ===================
async function processBBVAPDF(text) {
    logDebug('=== PROCESADOR BBVA MEJORADO ===');
    transactionData.length = 0;
    
    // Patr√≥n mejorado para transacciones BBVA
    const transactionPattern = /(\d{1,2}\/[A-Z]{3})\s+(\d{1,2}\/[A-Z]{3})\s+([^0-9]+?)\s+([\d,]+\.\d{2})/g;
    
    let match;
    const allTransactions = [];
    
    while ((match = transactionPattern.exec(text)) !== null) {
        const [fullMatch, date1, date2, description, amount] = match;
        const numAmount = parseFloat(amount.replace(/,/g, ''));
        
        if (numAmount > 0) {
            allTransactions.push({
                date1: date1,
                date2: date2,
                description: description.trim(),
                amount: numAmount,
                fullMatch: fullMatch
            });
        }
    }
    
    logDebug(`BBVA: Encontradas ${allTransactions.length} transacciones`);
    
    // Procesar cada transacci√≥n
    allTransactions.forEach(transaction => {
        const { description, amount, date1 } = transaction;
        const desc = description.toUpperCase();
        
        // Determinar si es ingreso o gasto
        let isIncome = false;
        
        if (desc.includes('SPEI RECIBIDO') || 
            desc.includes('DEPOSITO') && !desc.includes('TERCERO') ||
            desc.includes('ABONO') ||
            desc.includes('TRANSFERENCIA RECIBIDA') ||
            desc.includes('VENTA FONDOS') ||
            desc.includes('DEVOLUCION')) {
            isIncome = true;
        }
        
        const category = isIncome ? 'Ingresos' : categorizeExpenseByDescription(description);
        
        const processedTransaction = {
            description: description,
            amount: amount,
            date: parseBBVADate(date1),
            category: category,
            type: isIncome ? 'INGRESO' : 'GASTO',
            source: 'BBVA'
        };
        
        transactionData.push(processedTransaction);
    });
    
    logDebug(`BBVA procesado: ${transactionData.length} transacciones`);
}

// ===================
// PROCESADOR SANTANDER MEJORADO - BASADO EN TU PDF
// ===================
async function processSantanderPDF(text) {
    logDebug('=== PROCESADOR SANTANDER MEJORADO ===');
    transactionData.length = 0;
    
    const lines = text.split('\n');
    
    // Buscar secci√≥n de movimientos
    let inMovimientosSection = false;
    let totalCargos = 0;
    let totalAbonos = 0;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Detectar inicio de secci√≥n de movimientos
        if (line.includes('CARGOS, ABONOS Y COMPRAS REGULARES') || 
            line.includes('DESGLOSE DE MOVIMIENTOS')) {
            inMovimientosSection = true;
            logDebug('Encontrada secci√≥n de movimientos');
            continue;
        }
        
        // Detectar fin de secci√≥n
        if (line.includes('Total Cargos') || line.includes('Total Abonos')) {
            inMovimientosSection = false;
            continue;
        }
        
        if (inMovimientosSection && line.length > 10) {
            const transaction = parseSantanderTransaction(line);
            if (transaction) {
                transactionData.push(transaction);
                
                if (transaction.category === 'Ingresos') {
                    totalAbonos += transaction.amount;
                } else {
                    totalCargos += transaction.amount;
                }
            }
        }
    }
    
    // Tambi√©n buscar transacciones con formato de fecha espec√≠fico
    const datePattern = /(\d{2}-[A-Z]{3}-\d{4})/g;
    let match;
    
    while ((match = datePattern.exec(text)) !== null) {
        const dateStr = match[1];
        const lineStart = text.lastIndexOf('\n', match.index);
        const lineEnd = text.indexOf('\n', match.index);
        const fullLine = text.substring(lineStart, lineEnd).trim();
        
        if (fullLine.includes('$')) {
            const transaction = parseSantanderTransactionWithDate(fullLine, dateStr);
            if (transaction && !isDuplicateTransaction(transaction)) {
                transactionData.push(transaction);
            }
        }
    }
    
    logDebug(`Santander procesado: ${transactionData.length} transacciones`);
    logDebug(`Total cargos: $${totalCargos.toLocaleString()}`);
    logDebug(`Total abonos: $${totalAbonos.toLocaleString()}`);
}

function parseSantanderTransaction(line) {
    // Patr√≥n para l√≠neas como: "02-Dic-2024 AMAZON MX A MESES M 03M S/INT $ 916.00"
    const pattern = /(\d{2}-[A-Z]{3}-\d{4})\s+([^$]+)\$\s*([\d,]+\.?\d*)/;
    const match = line.match(pattern);
    
    if (!match) return null;
    
    const [_, dateStr, description, amountStr] = match;
    const amount = parseFloat(amountStr.replace(/,/g, ''));
    
    if (isNaN(amount) || amount <= 0) return null;
    
    // Determinar si es ingreso o gasto basado en descripci√≥n
    const desc = description.toUpperCase().trim();
    let isIncome = false;
    
    if (desc.includes('ABONO') || 
        desc.includes('DEPOSITO') ||
        desc.includes('TRANSFERENCIA RECIBIDA') ||
        desc.includes('DEVOLUCION')) {
        isIncome = true;
    }
    
    return {
        description: description.trim(),
        amount: amount,
        date: parseSantanderDate(dateStr),
        category: isIncome ? 'Ingresos' : categorizeExpenseByDescription(description),
        type: isIncome ? 'INGRESO' : 'GASTO',
        source: 'Santander'
    };
}

function parseSantanderTransactionWithDate(line, dateStr) {
    // Extraer monto
    const amountMatch = line.match(/\$\s*([\d,]+\.?\d*)/);
    if (!amountMatch) return null;
    
    const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
    if (isNaN(amount) || amount <= 0) return null;
    
    // Extraer descripci√≥n (texto entre fecha y monto)
    const description = line
        .replace(dateStr, '')
        .replace(amountMatch[0], '')
        .trim();
    
    if (description.length < 3) return null;
    
    const desc = description.toUpperCase();
    let isIncome = false;
    
    if (desc.includes('ABONO') || 
        desc.includes('DEPOSITO') ||
        desc.includes('TRANSFERENCIA RECIBIDA')) {
        isIncome = true;
    }
    
    return {
        description: description,
        amount: amount,
        date: parseSantanderDate(dateStr),
        category: isIncome ? 'Ingresos' : categorizeExpenseByDescription(description),
        type: isIncome ? 'INGRESO' : 'GASTO',
        source: 'Santander'
    };
}

function parseSantanderDate(dateStr) {
    // Convertir formato "02-Dic-2024" a Date
    const parts = dateStr.split('-');
    if (parts.length !== 3) return new Date();
    
    const day = parseInt(parts[0]);
    const monthStr = parts[1];
    const year = parseInt(parts[2]);
    
    const monthMap = {
        'Ene': 0, 'Feb': 1, 'Mar': 2, 'Abr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Ago': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dic': 11
    };
    
    const month = monthMap[monthStr];
    if (month === undefined) return new Date();
    
    return new Date(year, month, day);
}

function isDuplicateTransaction(newTransaction) {
    return transactionData.some(existing => 
        existing.description === newTransaction.description &&
        existing.amount === newTransaction.amount &&
        Math.abs(existing.date - newTransaction.date) < 24 * 60 * 60 * 1000 // Mismo d√≠a
    );
}

// ===================
// PROCESADOR NU
// ===================
async function processNuPDF(text) {
    logDebug('=== PROCESADOR NU ===');
    const lines = text.split('\n');
    transactionData = [];
    
    const transactionPattern = /(\d{1,2} [A-Z]{3} \d{4})\s+(.+?)\s+([-+]?\$?[\d,]+\.?\d*)/;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const match = line.match(transactionPattern);
        
        if (match) {
            const [_, fecha, descripcion, montoStr] = match;
            let amount = parseFloat(montoStr.replace(/[$,\s-]/g, ''));
            
            const isNegative = montoStr.includes('-');
            if (isNegative && amount > 0) {
                const transaction = {
                    description: descripcion.trim(),
                    amount: amount,
                    date: parseNuDate(fecha),
                    category: categorizeTransaction(descripcion),
                    source: 'Nu'
                };
                transactionData.push(transaction);
            }
        }
    }
    
    logDebug(`Nu procesado: ${transactionData.length} transacciones`);
}

// ===================
// PROCESADOR BANORTE
// ===================
async function processBanortePDF(text) {
    logDebug('=== PROCESADOR BANORTE ===');
    const lines = text.split('\n');
    transactionData = [];
    
    const datePattern = /(\d{2}-\d{2}-\d{4}|\d{2}\/\d{2}\/\d{4})/;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (datePattern.test(line) && line.includes('$')) {
            const parts = line.split(/\s+/);
            const fecha = parts.find(part => datePattern.test(part));
            const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
            
            if (fecha && montoMatch) {
                const descripcion = line.replace(fecha, '').replace(montoMatch[0], '').trim();
                const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                
                if (!isNaN(amount) && amount > 0) {
                    const transaction = {
                        description: descripcion,
                        amount: amount,
                        date: new Date(fecha.replace(/-/g, '/')),
                        category: categorizeTransaction(descripcion),
                        source: 'Banorte'
                    };
                    transactionData.push(transaction);
                }
            }
        }
    }
    
    logDebug(`Banorte procesado: ${transactionData.length} transacciones`);
}

// ===================
// PROCESADOR GEN√âRICO
// ===================
async function processGenericPDF(text) {
    logDebug('=== PROCESADOR GEN√âRICO ===');
    const lines = text.split('\n');
    transactionData = [];
    
    const datePatterns = [
        /(\d{1,2}\/\d{1,2}\/\d{4})/,
        /(\d{1,2}-\d{1,2}-\d{4})/,
        /(\d{1,2} [A-Z]{3} \d{4})/,
        /(\d{1,2}\/[A-Z]{3}\/\d{4})/
    ];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        let dateFound = null;
        for (const pattern of datePatterns) {
            const match = line.match(pattern);
            if (match) {
                dateFound = match[1];
                break;
            }
        }
        
        if (dateFound && line.includes('$')) {
            const montoMatch = line.match(/\$?([\d,]+\.?\d*)/);
            
            if (montoMatch) {
                const descripcion = line.replace(dateFound, '').replace(montoMatch[0], '').trim();
                const amount = parseFloat(montoMatch[1].replace(/,/g, ''));
                
                if (!isNaN(amount) && amount > 0 && descripcion.length > 5) {
                    const transaction = {
                        description: descripcion,
                        amount: amount,
                        date: new Date(dateFound),
                        category: categorizeTransaction(descripcion),
                        source: 'Gen√©rico'
                    };
                    transactionData.push(transaction);
                }
            }
        }
    }
    
    logDebug(`Gen√©rico procesado: ${transactionData.length} transacciones`);
}

// ===================
// FUNCIONES AUXILIARES DE PARSEO
// ===================
function parseTransaction(headers, values) {
    const transaction = {};
    
    const descriptionFields = ['descripcion', 'descripci√≥n', 'concepto', 'description', 'merchant', 'comercio', 'movimiento'];
    const amountFields = ['monto', 'importe', 'amount', 'cantidad', 'cargo', 'abono', 'importe neto'];
    const dateFields = ['fecha', 'date', 'dia'];
    
    let description = '';
    let amount = 0;
    let date = new Date();
    
    headers.forEach((header, index) => {
        const value = values[index];
        const headerLower = String(header || '').toLowerCase().trim();
        
        if (descriptionFields.some(field => headerLower.includes(field))) {
            description = String(value || '');
        }
        
        if (amountFields.some(field => headerLower.includes(field))) {
            const cleanValue = String(value || '0').replace(/[,$\s]/g, '');
            const numValue = parseFloat(cleanValue);
            if (!isNaN(numValue) && Math.abs(numValue) > Math.abs(amount)) {
                amount = numValue;
            }
        }
        
        if (dateFields.some(field => headerLower.includes(field))) {
            const dateValue = parseBBVADate(value);
            if (dateValue && !isNaN(dateValue.getTime())) {
                date = dateValue;
            }
        }
    });
    
    if (description && Math.abs(amount) > 0) {
        return {
            description: description,
            amount: Math.abs(amount),
            date: date,
            category: categorizeTransaction(description)
        };
    }
    
    return null;
}

function parseBBVADate(dateStr) {
    if (!dateStr) return new Date();
    
    const str = String(dateStr).trim();
    
    if (str.includes('/') && str.length <= 10) {
        const parts = str.split('/');
        if (parts.length === 2) {
            const day = parseInt(parts[0]);
            const monthStr = parts[1].toUpperCase();
            
            const monthMap = {
                'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
                'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
            };
            
            const month = monthMap[monthStr];
            if (month !== undefined && day >= 1 && day <= 31) {
                const currentYear = new Date().getFullYear();
                return new Date(currentYear, month, day);
            }
        }
    }
    
    const standardDate = new Date(dateStr);
    if (!isNaN(standardDate.getTime())) {
        return standardDate;
    }
    
    return new Date();
}

function parseNuDate(dateStr) {
    const parts = dateStr.split(' ');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const monthStr = parts[1];
        const year = parseInt(parts[2]);
        
        const monthMap = {
            'ENE': 0, 'FEB': 1, 'MAR': 2, 'ABR': 3, 'MAY': 4, 'JUN': 5,
            'JUL': 6, 'AGO': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DIC': 11
        };
        
        const month = monthMap[monthStr];
        if (month !== undefined) {
            return new Date(year, month, day);
        }
    }
    
    return new Date();
}

function categorizeTransaction(description) {
    const desc = description.toLowerCase();
    
    for (const [category, keywords] of Object.entries(categories)) {
        if (category === 'Otros') continue;
        
        for (const keyword of keywords) {
            if (desc.includes(keyword)) {
                return category;
            }
        }
    }
    
    return 'Otros';
}

function categorizeExpenseByDescription(description) {
    const desc = description.toUpperCase();
    
    // Transporte
    if (desc.includes('UBER') || desc.includes('TAXI') || desc.includes('GASOLINA') || desc.includes('GAS')) {
        return 'Transporte';
    }
    
    // Alimentaci√≥n
    if (desc.includes('ABARROTES') || desc.includes('SUPERMERCADO') || desc.includes('MERCADO') || desc.includes('TIENDA')) {
        return 'Alimentaci√≥n';
    }
    
    // Restaurantes
    if (desc.includes('RESTAURANT') || desc.includes('COMIDA') || desc.includes('FRUTA')) {
        return 'Restaurantes';
    }
    
    // Efectivo
    if (desc.includes('RETIRO') || desc.includes('CAJERO') || desc.includes('EFECTIVO') || desc.includes('ATM')) {
        return 'Efectivo';
    }
    
    // Transferencias/Pagos
    if (desc.includes('SPEI ENVIADO') || desc.includes('PAGO CUENTA') || desc.includes('TRANSFERENCIA')) {
        return 'Transferencias';
    }
    
    // Servicios
    if (desc.includes('PENSION') || desc.includes('RENTA') || desc.includes('DONATIVO')) {
        return 'Servicios';
    }
    
    // Salud
    if (desc.includes('FARMACIA') || desc.includes('FAR GUAD')) {
        return 'Salud';
    }
    
    // Compras
    if (desc.includes('AMAZON') || desc.includes('LIVERPOOL') || desc.includes('COMPRA')) {
        return 'Compras';
    }
    
    // Entretenimiento
    if (desc.includes('CINE') || desc.includes('JUEGO') || desc.includes('DIVERSIO')) {
        return 'Entretenimiento';
    }
    
    return 'Otros';
}

logDebug('Procesadores de archivos cargados correctamente');
                // ===================
// FLUJO DE PROCESAMIENTO MEJORADO
// ===================

async function startProcessingFlow() {
    const pendingFiles = fileQueue.filter(f => f.status === 'pending');
    
    if (pendingFiles.length === 0) {
        showNotification('No hay archivos para procesar', 'warning');
        return;
    }
    
    logDebug(`Iniciando procesamiento de ${pendingFiles.length} archivos`);
    
    // Limpiar datos previos
    allConsolidatedTransactions.length = 0;
    
    // Procesar todos los archivos
    for (const file of pendingFiles) {
        await processMultipleFile(file);
    }
    
    // Guardar datos procesados
    processedFilesData = fileQueue.filter(f => f.status === 'completed');
    
    // Consolidar transacciones de todos los archivos
    processedFilesData.forEach(file => {
        if (file.transactions && file.transactions.length > 0) {
            allConsolidatedTransactions.push(...file.transactions);
        }
    });
    
    logDebug(`Consolidaci√≥n completa: ${allConsolidatedTransactions.length} transacciones totales`);
    
    // Pasar al paso 2: Gastos manuales
    showManualExpensesStep();
}

async function processMultipleFile(fileItem) {
    fileItem.status = 'processing';
    fileItem.progress = 0;
    updateImprovedFilesDisplay();

    try {
        const file = fileItem.file;
        const ext = file.name.split('.').pop().toLowerCase();
        
        fileItem.progress = 25;
        updateImprovedFilesDisplay();
        
        // Limpiar transactionData temporal
        const tempTransactionData = [];
        
        if (ext === 'pdf') {
            await processMultiplePDF(file, tempTransactionData);
        } else if (ext === 'xlsx' || ext === 'xls') {
            await processMultipleExcel(file, tempTransactionData);
        } else if (ext === 'csv') {
            await processMultipleCSV(file, tempTransactionData);
        }
        
        fileItem.progress = 75;
        updateImprovedFilesDisplay();
        
        // Guardar transacciones en el archivo
        fileItem.transactions = tempTransactionData;
        fileItem.progress = 100;
        fileItem.status = 'completed';
        
        showNotification(`${file.name} procesado: ${tempTransactionData.length} transacciones`, 'success');
        
    } catch (error) {
        fileItem.status = 'error';
        fileItem.error = error.message;
        logError(`Error procesando ${fileItem.name}`, error);
        showNotification(`Error en ${fileItem.name}: ${error.message}`, 'error');
    }
    
    updateImprovedFilesDisplay();
}

// Procesadores espec√≠ficos para m√∫ltiples archivos
async function processMultiplePDF(file, tempTransactionData) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
    }
    
    // Usar el procesador existente pero guardar en tempTransactionData
    const originalTransactionData = transactionData;
    transactionData = tempTransactionData;
    
    if (fullText.includes('BBVA')) {
        await processBBVAPDF(fullText);
    } else if (fullText.includes('Santander')) {
        await processSantanderPDF(fullText);
    } else if (fullText.includes('Nu M√©xico')) {
        await processNuPDF(fullText);
    } else if (fullText.includes('Banorte')) {
        await processBanortePDF(fullText);
    } else {
        await processGenericPDF(fullText);
    }
    
    // Restaurar transactionData original
    transactionData = originalTransactionData;
}

async function processMultipleExcel(file, tempTransactionData) {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    
    const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
    
    for (let i = 1; i < jsonData.length; i++) {
        if (jsonData[i].length > 0) {
            const transaction = parseTransaction(headers, jsonData[i]);
            if (transaction) {
                tempTransactionData.push(transaction);
            }
        }
    }
}

async function processMultipleCSV(file, tempTransactionData) {
    const text = await file.text();
    const lines = text.split('\n');
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            const values = lines[i].split(',');
            const transaction = parseTransaction(headers, values);
            if (transaction) {
                tempTransactionData.push(transaction);
            }
        }
    }
}

// ===================
// GASTOS MANUALES
// ===================

function showManualExpensesStep() {
    currentStep = 2;
    
    // Ocultar secciones anteriores
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('filesQueueSection').style.display = 'none';
    
    // Mostrar secci√≥n de gastos manuales
    document.getElementById('manualExpensesFlow').style.display = 'block';
    document.getElementById('manualExpensesFlow').scrollIntoView({ behavior: 'smooth' });
    
    // Actualizar informaci√≥n de archivos procesados
    updateProcessedInfo();
    
    showNotification(`Procesados ${processedFilesData.length} archivos correctamente. Ahora agrega gastos en efectivo.`, 'success');
}

function updateProcessedInfo() {
    const banksInfo = document.getElementById('processedBanksInfo');
    const transactionsInfo = document.getElementById('processedTransactionsInfo');
    
    if (!banksInfo || !transactionsInfo) return;
    
    const bankNames = processedFilesData.map(f => f.bank.name).join(', ');
    banksInfo.textContent = `${processedFilesData.length} archivo${processedFilesData.length > 1 ? 's' : ''} (${bankNames})`;
    transactionsInfo.textContent = allConsolidatedTransactions.length;
}

function addQuickExpense() {
    const description = document.getElementById('quickExpenseDescription').value.trim();
    const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
    const category = document.getElementById('quickExpenseCategory').value;

    // Validaciones
    if (!description) {
        showNotification('Por favor ingresa una descripci√≥n', 'error');
        document.getElementById('quickExpenseDescription').focus();
        return;
    }
    
    if (!amount || amount <= 0) {
        showNotification('Por favor ingresa un monto v√°lido', 'error');
        document.getElementById('quickExpenseAmount').focus();
        return;
    }
    
    if (!category) {
        showNotification('Por favor selecciona una categor√≠a', 'error');
        document.getElementById('quickExpenseCategory').focus();
        return;
    }

    // Crear gasto manual
    const expense = {
        id: `manual_${Date.now()}`,
        description: description,
        amount: amount,
        category: category,
        date: new Date(),
        isManual: true,
        source: 'Efectivo'
    };

    quickManualExpenses.push(expense);
    updateQuickExpensesList();
    clearQuickExpenseForm();
    
    showNotification(`Gasto de $${amount.toLocaleString()} agregado`, 'success');
}

function updateQuickExpensesList() {
    const list = document.getElementById('quickExpensesList');
    
    if (!list) return;
    
    if (quickManualExpenses.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: #718096;">No hay gastos en efectivo agregados</div>';
        return;
    }

    const totalManual = quickManualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    
    list.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
            <h4 style="color: #667eea; margin: 0;">üíµ Gastos en Efectivo (${quickManualExpenses.length})</h4>
            <div style="font-weight: bold; color: #667eea; font-size: 1.2rem;">Total: $${totalManual.toLocaleString()}</div>
        </div>
        ${quickManualExpenses.map((expense, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${expense.description}</div>
                    <div style="font-size: 0.8rem; color: #718096;">${expense.category}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-weight: bold; color: #667eea;">$${expense.amount.toLocaleString()}</div>
                    <button onclick="removeQuickExpense(${index})" style="background: #fed7d7; color: #e53e3e; border: none; padding: 5px 8px; border-radius: 50%; cursor: pointer; font-size: 0.8rem;">√ó</button>
                </div>
            </div>
        `).join('')}
    `;
}

function removeQuickExpense(index) {
    if (index >= 0 && index < quickManualExpenses.length) {
        quickManualExpenses.splice(index, 1);
        updateQuickExpensesList();
        showNotification('Gasto eliminado', 'success');
    }
}

function clearQuickExpenseForm() {
    document.getElementById('quickExpenseDescription').value = '';
    document.getElementById('quickExpenseAmount').value = '';
    document.getElementById('quickExpenseCategory').value = '';
    document.getElementById('quickExpenseDescription').focus();
}

function skipManualExpenses() {
    proceedToConsolidated();
}

function proceedToConsolidated() {
    currentStep = 3;
    
    // Combinar todas las transacciones
    transactionData.length = 0;
    
    // Agregar transacciones de archivos
    allConsolidatedTransactions.forEach(t => {
        transactionData.push({...t, source: t.source || 'Bancario'});
    });
    
    // Agregar gastos manuales
    quickManualExpenses.forEach(expense => {
        transactionData.push({...expense, source: 'Efectivo'});
    });

    // Ocultar paso anterior
    document.getElementById('manualExpensesFlow').style.display = 'none';
    
    // Ejecutar an√°lisis
    analyzeData();
    
    // Mostrar resultados consolidados
    showResults();
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    
    // Mostrar informaci√≥n consolidada
    showConsolidatedInfo();
    
    showNotification('¬°An√°lisis consolidado completado!', 'success');
}

function showConsolidatedInfo() {
    const resultsSection = document.getElementById('resultsSection');
    if (!resultsSection) return;
    
    // Verificar si ya existe el banner
    const existingBanner = resultsSection.querySelector('.consolidated-banner');
    if (existingBanner) {
        existingBanner.remove();
    }
    
    const consolidatedBanner = document.createElement('div');
    consolidatedBanner.className = 'consolidated-banner';
    consolidatedBanner.style.cssText = `
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    `;
    
    const banksList = processedFilesData.map(f => f.bank.name).join(', ');
    const manualTotal = quickManualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    
    consolidatedBanner.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 1.5rem;">üìä An√°lisis Financiero Consolidado</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div>
                <div style="font-size: 1.8rem; font-weight: bold;">${processedFilesData.length}</div>
                <div style="opacity: 0.9;">Estado${processedFilesData.length > 1 ? 's' : ''} de Cuenta</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">${banksList}</div>
            </div>
            <div>
                <div style="font-size: 1.8rem; font-weight: bold;">${quickManualExpenses.length}</div>
                <div style="opacity: 0.9;">Gastos en Efectivo</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">$${manualTotal.toLocaleString()}</div>
            </div>
            <div>
                <div style="font-size: 1.8rem; font-weight: bold;">${transactionData.length}</div>
                <div style="opacity: 0.9;">Transacciones Totales</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">An√°lisis Completo</div>
            </div>
        </div>
    `;
    
    resultsSection.insertBefore(consolidatedBanner, resultsSection.firstChild);
}

// ===================
// AN√ÅLISIS DE DATOS
// ===================

function analyzeData() {
    logDebug('Iniciando an√°lisis de datos', `${transactionData.length} transacciones`);
    
    // Separar ingresos y gastos
    const ingresos = transactionData.filter(t => t.category === 'Ingresos');
    const gastos = transactionData.filter(t => t.category !== 'Ingresos');
    
    const totalIngresos = ingresos.reduce((sum, t) => sum + t.amount, 0);
    const totalGastos = gastos.reduce((sum, t) => sum + t.amount, 0);
    const totalTransactions = transactionData.length;
    
    // Calcular m√©tricas financieras
    const ahorroReal = totalIngresos - totalGastos;
    const porcentajeAhorro = totalIngresos > 0 ? ((ahorroReal / totalIngresos) * 100) : 0;
    
    // Categorizar solo gastos para el an√°lisis
    const categoryTotals = {};
    gastos.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
    });
    
    const topCategory = Object.keys(categoryTotals).length > 0 ? 
        Object.keys(categoryTotals).reduce((a, b) => 
            categoryTotals[a] > categoryTotals[b] ? a : b
        ) : 'N/A';
    
    // Actualizar m√©tricas en pantalla
    updateElement('totalIngresos', `$${totalIngresos.toLocaleString()}`);
    updateElement('totalExpenses', `$${totalGastos.toLocaleString()}`);
    updateElement('ahorroReal', `$${ahorroReal.toLocaleString()}`);
    updateElement('porcentajeAhorro', `${porcentajeAhorro.toFixed(1)}%`);
    updateElement('totalTransactions', totalTransactions.toLocaleString());
    updateElement('topCategory', topCategory);
    
    // Crear gr√°ficos
    createCategoryChart(categoryTotals);
    createTrendChart();
    createBudgetSuggestions(categoryTotals, totalGastos, totalIngresos);
    
    logDebug('An√°lisis completado', {
        ingresos: totalIngresos,
        gastos: totalGastos,
        ahorro: ahorroReal,
        transacciones: totalTransactions
    });
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

// ===================
// GR√ÅFICOS
// ===================

function createCategoryChart(categoryTotals) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    if (categoryChart) {
        categoryChart.destroy();
    }
    
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
        '#81C784', '#FFB74D', '#F06292', '#BA68C8'
    ];
    
    categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryTotals),
            datasets: [{
                data: Object.values(categoryTotals),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createTrendChart() {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    // Agrupar por mes
    const monthlyData = {};
    transactionData.forEach(t => {
        if (t.category !== 'Ingresos') { // Solo gastos para la tendencia
            const monthKey = t.date.toISOString().substring(0, 7);
            monthlyData[monthKey] = (monthlyData[monthKey] || 0) + t.amount;
        }
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
            }),
            datasets: [{
                label: 'Gastos Mensuales',
                data: sortedMonths.map(month => monthlyData[month]),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Gastos: $${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function createBudgetSuggestions(categoryTotals, totalExpenses, totalIngresos = 0) {
    const budgetContainer = document.getElementById('budgetCategories');
    if (!budgetContainer) return;
    
    budgetContainer.innerHTML = '';
    
    // Mostrar an√°lisis de ingresos vs gastos si hay ingresos
    if (totalIngresos > 0) {
        const ratioGastos = ((totalExpenses / totalIngresos) * 100).toFixed(1);
        const ahorroSugerido = totalIngresos * 0.2; // 20% de ahorro recomendado
        
        const summaryItem = document.createElement('div');
        summaryItem.className = 'budget-item';
        summaryItem.style.gridColumn = '1 / -1';
        summaryItem.style.background = ratioGastos > 80 ? 'rgba(255, 99, 132, 0.1)' : 'rgba(75, 192, 192, 0.1)';
        summaryItem.innerHTML = `
            <div>
                <div class="category-name">üìä An√°lisis Financiero</div>
                <div style="font-size: 0.9rem; color: #718096;">
                    Gastas ${ratioGastos}% de tus ingresos ‚Ä¢ 
                    ${ratioGastos > 80 ? '‚ö†Ô∏è Riesgo alto' : ratioGastos > 60 ? '‚ö° Moderado' : '‚úÖ Saludable'}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: #718096;">Ahorro sugerido</div>
                <div class="budget-amount">$${ahorroSugerido.toLocaleString()}</div>
            </div>
        `;
        budgetContainer.appendChild(summaryItem);
    }
    
    const improvementFactor = 0.9; // Sugerir 10% de reducci√≥n
    
    Object.entries(categoryTotals).forEach(([category, amount]) => {
        const suggestedAmount = Math.round(amount * improvementFactor);
        const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
        
        const budgetItem = document.createElement('div');
        budgetItem.className = 'budget-item';
        budgetItem.innerHTML = `
            <div>
                <div class="category-name">${category}</div>
                <div style="font-size: 0.9rem; color: #718096;">${percentage}% del total</div>
            </div>
            <div class="budget-amount">$${suggestedAmount.toLocaleString()}</div>
        `;
        
        budgetContainer.appendChild(budgetItem);
    });
}

// ===================
// FUNCIONES DE EXPORTACI√ìN
// ===================

function exportResults() {
    const data = {
        fecha: new Date().toISOString(),
        resumen: {
            totalTransacciones: transactionData.length,
            totalIngresos: transactionData.filter(t => t.category === 'Ingresos').reduce((sum, t) => sum + t.amount, 0),
            totalGastos: transactionData.filter(t => t.category !== 'Ingresos').reduce((sum, t) => sum + t.amount, 0)
        },
        transacciones: transactionData,
        archivosProcesados: processedFilesData.map(f => ({
            nombre: f.name,
            banco: f.bank.name,
            transacciones: f.transactions?.length || 0
        })),
        gastosEfectivo: quickManualExpenses
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis-presupuesto-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Resultados exportados correctamente', 'success');
}

logDebug('JavaScript UI cargado correctamente');
